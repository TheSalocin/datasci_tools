<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>datasci_tools.pandas_utils &mdash; datasci_tools 1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=404a92a0"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            datasci_tools
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">datasci_tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">datasci_tools</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">datasci_tools.pandas_utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for datasci_tools.pandas_utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>



<span class="sd">Purpose: To make pandas table manipulation easier</span>



<span class="sd">Some useful functions: </span>
<span class="sd">#sets the index to a specific column and doesn&#39;t return dataframe but modifies the existing one</span>
<span class="sd">df.set_index(&#39;Mountain&#39;, inplace=True) </span>

<span class="sd">Selecting Data: </span>
<span class="sd">i) selecting columns</span>
<span class="sd">- all columns are attribtues so can select with the &quot;.&quot; (Ex: df.myCol)</span>
<span class="sd">- if there are wierd spaces could do getattr(df, &#39;Height (m)&#39;)</span>
<span class="sd">- BEST WAY: df[&#39;Height (m)&#39;] because can select multiple columns at a time:</span>
<span class="sd">        df[[&#39;Height (m)&#39;, &#39;Range&#39;, &#39;Coordinates&#39;]]</span>

<span class="sd">ii) Selecting Rows (with slicing): </span>
<span class="sd">- Can do that with index: a[start:stop:step]  (Ex: df[2:8:2])</span>
<span class="sd">- if you changed he index to be a certain column with non-numeric values: df[&#39;Lhotse&#39;:&#39;Manaslu&#39;]</span>
<span class="sd">        slicing is inclusive at both start and end</span>

<span class="sd">iii) Specific data points: </span>
<span class="sd">a) ** df.iloc** When just want to use numbers to reference</span>
<span class="sd">- df.iloc[rows, columns] for rows/col it can be: single int, list of ints, slices, : (for all)</span>
<span class="sd">  Ex: df.iloc[:, 2:6]** when </span>
<span class="sd">  </span>
<span class="sd">b) ** df.loc where can use the names of things and not just numbers**</span>
<span class="sd">- df.loc[rows,columns]</span>
<span class="sd">   rows: index label, list of index labels, slice of index labels,:</span>
<span class="sd">   cols; singl column name, list of col names, slice of col names, :</span>
<span class="sd">   --&gt; remember if do slice then it is inclusive on both start and stop</span>
<span class="sd">   </span>
<span class="sd">Ex: df.loc[:,&#39;Height (m)&#39;:&#39;First ascent&#39;]</span>


<span class="sd">c) Boolean selection: </span>
<span class="sd">- can select rows with true/false mask--&gt; 1) Create true false mask, put inside df[ ]</span>
<span class="sd">Ex: df[df[&#39;Height (m)&#39;] &gt; 8000]</span>

<span class="sd">For putting multiple conditions together the operators are: &amp;,|,~</span>

<span class="sd">Have to use parenthesis to seperate multiple conditions: </span>
<span class="sd">df[(df[&#39;Height (m)&#39;] &gt; 8000) &amp; (df[&#39;Range&#39;]==&#39;Mahalangur Himalaya&#39;)]</span>

<span class="sd">- Can use the loc operator to apply the mask and then select subset of columns: </span>
<span class="sd">df.loc[(df[&#39;Height (m)&#39;] &gt; 8000) &amp; (df[&#39;Range&#39;]==&#39;Mahalangur Himalaya&#39;), &#39;Height (m)&#39;:&#39;Range&#39;]</span>

<span class="sd">Can also select the columns using a boolean operator: </span>
<span class="sd">- col_criteria = [True, False, False, False, True, True, False]</span>
<span class="sd">  df.loc[df[&#39;Height (m)&#39;] &gt; 8000, col_criteria]</span>
<span class="sd">  </span>
<span class="sd">  </span>
<span class="sd">- To delete a column:</span>
<span class="sd">del neuron_df[&quot;random_value&quot;]</span>




<span class="sd">------------------------------------pd.eval, df.eval df.query ------------------------------</span>
<span class="sd">Purpose: All of these functions are used to either</span>
<span class="sd">1) create masks of your rows</span>
<span class="sd">2) filter for specific rows </span>
<span class="sd">3) make new data columns</span>

<span class="sd">pd.query:</span>
<span class="sd">- Can reference other dataframes by name and their columns with the attribute &quot;.&quot;</span>
<span class="sd">pd.eval(&quot;df1.A + df2.A&quot;)   # Valid, returns a pd.Series object</span>
<span class="sd">pd.eval(&quot;abs(df1) ** .5&quot;)  # Valid, returns a pd.DataFrame object</span>

<span class="sd">- can evaluate conditional expressions: </span>
<span class="sd">pd.eval(&quot;df1 &gt; df2&quot;)        </span>
<span class="sd">pd.eval(&quot;df1 &gt; 5&quot;)    </span>
<span class="sd">pd.eval(&quot;df1 &lt; df2 and df3 &lt; df4&quot;)      </span>
<span class="sd">pd.eval(&quot;df1 in [1, 2, 3]&quot;)</span>
<span class="sd">pd.eval(&quot;1 &lt; 2 &lt; 3&quot;)</span>


<span class="sd">Arguments that are specific:</span>
<span class="sd">- can use &amp; or and (same thing)</span>

<span class="sd">** parser = &quot;python&quot; or &quot;pandas&quot; **</span>
<span class="sd">pandas: evaluates some Order of Operations differently</span>
<span class="sd">&gt; is higher proirity than &amp;</span>
<span class="sd">== is same thing as in  Ex: pd.eval(&quot;df1 in [1, 2, 3]&quot;) same as pd.eval(&quot;df1 == [1, 2, 3]&quot;)</span>

<span class="sd">python: if want traditional rules</span>


<span class="sd">** engine = &quot;numexpr&quot; or &quot;python&quot; ***</span>

<span class="sd">python: </span>
<span class="sd">1) can do more inside your expressions but it is not as fast</span>
<span class="sd">Example: </span>
<span class="sd">df = pd.DataFrame({&#39;A&#39;: [&#39;abc&#39;, &#39;def&#39;, &#39;abacus&#39;]})</span>
<span class="sd">pd.eval(&#39;df.A.str.contains(&quot;ab&quot;)&#39;, engine=&#39;python&#39;)</span>

<span class="sd">2) can reference variables with dictionary like syntax (not worth it)</span>



<span class="sd">---------- things can do with pd.eval -----------</span>
<span class="sd">1) Pass in dictionary to define variables that not defined </span>
<span class="sd">        (otherwise uses global variable with same name)</span>

<span class="sd">pd.eval(&quot;df1 &gt; thresh&quot;, local_dict={&#39;thresh&#39;: 10})</span>


<span class="sd">---------- things can do with pd.eval -----------</span>
<span class="sd">1) only have to write column names in queries because only applied</span>
<span class="sd">to one dataframe so don&#39;t need to put name in front</span>

<span class="sd">df1.eval(&quot;A + B&quot;)</span>

<span class="sd">2) Have to put @ in front of variables to avoid confusion with column names</span>
<span class="sd">A = 5</span>
<span class="sd">df1.eval(&quot;A &gt; @A&quot;) </span>


<span class="sd">3) Can do multiline queries and assignments:</span>

<span class="sd">df1.eval(&quot;&quot;&quot;</span>
<span class="sd">E = A + B</span>
<span class="sd">F = @df2.A + @df2.B</span>
<span class="sd">G = E &gt;= F</span>
<span class="sd">&quot;&quot;&quot;)</span>

<span class="sd">Can still do the local dict:</span>
<span class="sd">returned_df.query(&quot;n_faces_branch &gt; @x&quot;,local_dict=dict(x=10000))</span>

<span class="sd">----------- Difference between df1.eval and df1.query -----------</span>
<span class="sd">if you are returning a True/False test, then df1.eval will just</span>
<span class="sd">return the True/False array whereas df1.query will go one step further</span>
<span class="sd">and restrict the dataframe to only those rows that are true</span>

<span class="sd">AKA: df1.eval is an intermediate step of df1.query </span>
<span class="sd">(could use the df1.eval output to restrict rows by df1[output_eval])</span>


<span class="sd">---------------------------Examples--------------------------</span>

<span class="sd">Ex_1: How to check if inside a list</span>
<span class="sd">list_of_faces = [1038,5763,7063,11405]</span>
<span class="sd">returned_df.query(&quot;n_faces_branch in @list_of_faces&quot;,local_dict=dict(list_of_faces=list_of_faces))</span>

<span class="sd">Ex_2: Adding Ands/Ors</span>

<span class="sd">list_of_faces = [1038,5763,7063,11405]</span>
<span class="sd">branch_threshold = 31000</span>
<span class="sd">returned_df.query(&quot;n_faces_branch in @list_of_faces or skeleton_distance_branch &gt; @branch_threshold&quot;,</span>
<span class="sd">                  local_dict=dict(list_of_faces=list_of_faces,branch_threshold=branch_threshold))</span>
<span class="sd">                  </span>
<span class="sd">Ex 2: of how to restrict a column to being a member or not being in a list</span>
<span class="sd">cell_df.query(&quot;not segment_id in @error_segments&quot;,local_dict=dict(error_seegments=error_segments))</span>


<span class="sd">--- 5/4 -----</span>
<span class="sd">How to query for null values: </span>
<span class="sd">df.query(&#39;value &lt; 10 | value.isnull()&#39;, engine=&#39;python&#39;)</span>

<span class="sd">ORRRRRR you could just check that the col not equal to itself (will get none values)</span>
<span class="sd">filt_df.query(&quot;cell_type_coarse != cell_type_coarse&quot;)</span>
<span class="sd"> </span>

<span class="sd">--- 6/14: Review of how to check if in list -------</span>

<span class="sd">df = pd.DataFrame({&quot;a&quot;:[1,2,3,4],&quot;b&quot;:[2,3,4,5]})</span>
<span class="sd">curr_list = [1,2]</span>
<span class="sd">df.query(&quot;a in @my_list&quot;,</span>
<span class="sd">        local_dict = dict(my_list=curr_list))</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">-- 12/8 : how to modify something in place using index and column</span>

<span class="sd">idx_to_change = df.query(&quot;axon == 0&quot;).index</span>
<span class="sd">df.loc[idx_to_change,&quot;synapse_density&quot;] = df.loc[idx_to_change,&quot;synapse_density&quot;]*df.loc[idx_to_change,&quot;n_synapses_post&quot;] / df.loc[idx_to_change,&quot;n_synapses&quot;]</span>
<span class="sd">df.loc[idx_to_change,&quot;n_synapses&quot;] =  df.loc[idx_to_change,&quot;n_synapses_post&quot;]</span>
<span class="sd">df.loc[idx_to_change,&quot;n_synapses_pre&quot;]  =  0</span>
<span class="sd">df.loc[idx_to_change,&quot;synapse_density_pre&quot;]  =  0</span>


<span class="sd">----- PIVOT TABLES ----</span>

<span class="sd">Pivot table:</span>
<span class="sd">Index: The rows you want for your pivot table</span>
<span class="sd">values: columns you want (wha tthe aggre will work on )</span>
<span class="sd">aggfun: can be a list of things on how you want that combination to be combined</span>
<span class="sd">columns: if you wanted to break the data further by columns and then the value</span>
<span class="sd">in the boxes is just what you specify</span>

<span class="sd">--- applying a function to split dataframe ---</span>
<span class="sd">.agg is just a way of applying something to columns of a grouped dataframe</span>
<span class="sd">.apply runs a function on the split grouped dataframe</span>


<span class="sd">.apply is a function that is very adaptable to the input given but usually</span>
<span class="sd">better to send data to vectorized function</span>
<span class="sd"> --&gt; link: https://towardsdatascience.com/avoiding-apply-ing-yourself-in-pandas-a6ade4569b7f</span>





<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">numpy_dep</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pandasql</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">pd_source</span> <span class="o">=</span> <span class="s2">&quot;pandas&quot;</span>

<span class="c1">#from pandas import util</span>

<div class="viewcode-block" id="random_dataframe"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.random_dataframe">[docs]</a><span class="k">def</span> <span class="nf">random_dataframe</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">makeDataFrame</span><span class="p">()</span></div>

<div class="viewcode-block" id="random_dataframe_with_missing_data"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.random_dataframe_with_missing_data">[docs]</a><span class="k">def</span> <span class="nf">random_dataframe_with_missing_data</span><span class="p">():</span>
    <span class="n">util</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">makeMissingDataframe</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="dataframe_to_row_dicts"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.dataframe_to_row_dicts">[docs]</a><span class="k">def</span> <span class="nf">dataframe_to_row_dicts</span><span class="p">(</span><span class="n">df</span><span class="p">,):</span>
    <span class="k">if</span> <span class="n">pu</span><span class="o">.</span><span class="n">is_series</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span></div>

<span class="n">df_to_dicts</span> <span class="o">=</span> <span class="n">dataframe_to_row_dicts</span>

<div class="viewcode-block" id="df_to_dicts_index_key"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.df_to_dicts_index_key">[docs]</a><span class="k">def</span> <span class="nf">df_to_dicts_index_key</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">index_column</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
    <span class="k">if</span> <span class="n">index_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index_column</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="nans_in_column"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.nans_in_column">[docs]</a><span class="k">def</span> <span class="nf">nans_in_column</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span></div>

<div class="viewcode-block" id="n_nans_per_column"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.n_nans_per_column">[docs]</a><span class="k">def</span> <span class="nf">n_nans_per_column</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>

<div class="viewcode-block" id="n_nans_total"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.n_nans_total">[docs]</a><span class="k">def</span> <span class="nf">n_nans_total</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>

<div class="viewcode-block" id="surpress_scientific_notation"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.surpress_scientific_notation">[docs]</a><span class="k">def</span> <span class="nf">surpress_scientific_notation</span><span class="p">():</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span></div>
    
<span class="c1">#import pandas as pd</span>
<span class="c1">#import pandasql</span>

<div class="viewcode-block" id="set_pd_from_modin"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.set_pd_from_modin">[docs]</a><span class="k">def</span> <span class="nf">set_pd_from_modin</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This library supposedly speeds up pandas functions</span>
<span class="sd">    by using multiple cores at once (made some things longer tho...)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">pd</span>
    <span class="kn">import</span> <span class="nn">modin.pandas</span> <span class="k">as</span> <span class="nn">pd_modin</span>
    <span class="n">pd</span> <span class="o">=</span> <span class="n">pd_modin</span></div>
    
<div class="viewcode-block" id="set_pd_from_pandas"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.set_pd_from_pandas">[docs]</a><span class="k">def</span> <span class="nf">set_pd_from_pandas</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">pd</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pdu</span>
    <span class="n">pd</span> <span class="o">=</span> <span class="n">pdu</span></div>

<div class="viewcode-block" id="restrict_pandas"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.restrict_pandas">[docs]</a><span class="k">def</span> <span class="nf">restrict_pandas</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">index_restriction</span><span class="o">=</span><span class="p">[],</span><span class="n">column_restriction</span><span class="o">=</span><span class="p">[],</span><span class="n">value_restriction</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pseudocode:</span>
<span class="sd">    How to specify:</span>
<span class="sd">    1) restrict rows by value (being equal,less than or greater) --&gt; just parse the string, SO CAN INCLUDE AND</span>
<span class="sd">    2) Columns you want to keep</span>
<span class="sd">    3) Indexes you want to keep:</span>
<span class="sd">    </span>
<span class="sd">    Example: </span>
<span class="sd">    </span>
<span class="sd">    index_restriction = [&quot;n=50&quot;,&quot;p=0.25&quot;,&quot;erdos_renyi_random_location_n=100_p=0.10&quot;]</span>
<span class="sd">    column_restriction = [&quot;size_maximum_clique&quot;,&quot;n_triangles&quot;]</span>
<span class="sd">    value_restriction = &quot;transitivity &gt; 0.3 AND size_maximum_clique &lt; 9 &quot;</span>
<span class="sd">    returned_df = restrict_pandas(df,index_restriction,column_restriction,value_restriction)</span>
<span class="sd">    returned_df</span>
<span class="sd">    </span>
<span class="sd">    Example of another restriction = &quot;(transitivity &gt; 0.1 AND n_maximal_cliques &gt; 10) OR (min_weighted_vertex_cover_len = 18 AND size_maximum_clique = 2)&quot;</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    #how to restrict by certain value in a column being a list </span>
<span class="sd">    df[~df[&#39;stn&#39;].isin(remove_list)]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_restriction</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">list_of_indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_df</span><span class="p">[</span><span class="n">graph_name</span><span class="p">])</span>
        <span class="n">restricted_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">list_of_indexes</span> <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">index_restriction</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">k</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="c1">#print(&quot;restricted_rows = &quot; + str(restricted_rows))</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="n">new_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_df</span><span class="p">[</span><span class="n">graph_name</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">restricted_rows</span><span class="p">)]</span>
        
    <span class="c1">#do the sql string from function:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value_restriction</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;SELECT * &quot;</span>
            <span class="s2">&quot;FROM new_df WHERE &quot;</span>
            <span class="o">+</span> <span class="n">value_restriction</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span>
        
        <span class="c1">#print(&quot;s = &quot; + str(s))</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="n">pandasql</span><span class="o">.</span><span class="n">sqldf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">locals</span><span class="p">())</span>
        
    <span class="c1">#print(new_df)</span>
    
    <span class="c1">#restrict by the columns:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_restriction</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1">#column_restriction.insert(0,graph_name)</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="n">new_df</span><span class="p">[</span><span class="n">column_restriction</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">new_df</span></div>

<span class="c1">#import re</span>
<div class="viewcode-block" id="rewrite_sql_functions_in_query"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.rewrite_sql_functions_in_query">[docs]</a><span class="k">def</span> <span class="nf">rewrite_sql_functions_in_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span>
                                  <span class="n">function_names</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                   <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                   <span class="o">**</span><span class="n">kwargs</span>
                                  <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To replace a sql keyword function</span>
<span class="sd">    inside a query so it will work with sql querying</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">convert_func</span><span class="p">(</span><span class="n">match_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;(SELECT </span><span class="si">{</span><span class="n">match_obj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">match_obj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">) FROM df)&quot;</span>
    
    <span class="k">if</span> <span class="n">function_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">function_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MAX&quot;</span><span class="p">,</span><span class="s2">&quot;MIN&quot;</span><span class="p">]</span>
        
    <span class="k">for</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="n">function_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---Working on </span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s2">---&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;before replace:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="n">sql_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">fr</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">func_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">func_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">)\(([A-Za-z0-9_\s]+)\)&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">sql_pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">convert_func</span><span class="p">,</span><span class="n">query</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;after replace:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">query</span></div>
        
    
    
        
<span class="c1">#import math</span>
<div class="viewcode-block" id="query"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.query">[docs]</a><span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">query</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PUrpose: To query a dataframe using an query </span>
<span class="sd">    that would work with sql</span>
<span class="sd">    </span>
<span class="sd">    Ex:</span>
<span class="sd">    from datasci_tools import pandas_utils as pu</span>
<span class="sd">    import pandas as pd</span>

<span class="sd">    curr_dicts = [dict(x = 5,y=10),dict(x = 7,y=11)]</span>
<span class="sd">    df = pd.DataFrame.from_records(curr_dicts)</span>
<span class="sd">    s = &quot;(x == MAX( x )) or (y = min(y))&quot;</span>

<span class="sd">    #s = pu.rewrite_sql_functions_in_query(s)</span>
<span class="sd">    pu.query(df,s)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_orig</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">index_name</span> <span class="o">=</span> <span class="s2">&quot;xyzilij&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        

        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;SELECT * &quot;</span>
            <span class="s2">&quot;FROM df WHERE &quot;</span>
            <span class="o">+</span> <span class="n">query</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="n">s_cp</span> <span class="o">=</span> <span class="n">s</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">rewrite_sql_functions_in_query</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        
        <span class="n">df</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">filter_away_columns_by_data_type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">new_df</span> <span class="o">=</span> <span class="n">pandasql</span><span class="o">.</span><span class="n">sqldf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">locals</span><span class="p">())</span>
        <span class="c1">#new_df = pu.delete_columns(new_df,index_name)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_df</span><span class="p">[</span><span class="n">index_name</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df_orig</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[],:]</span>
        <span class="n">return_df</span> <span class="o">=</span> <span class="n">df_orig</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">new_df</span><span class="p">[</span><span class="n">index_name</span><span class="p">],:]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">return_df</span> <span class="o">=</span> <span class="n">df_orig</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        
    <span class="n">return_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">delete_columns</span><span class="p">(</span><span class="n">return_df</span><span class="p">,</span><span class="n">index_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">return_df</span></div>
    

<div class="viewcode-block" id="turn_off_scientific_notation"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.turn_off_scientific_notation">[docs]</a><span class="k">def</span> <span class="nf">turn_off_scientific_notation</span><span class="p">(</span><span class="n">n_decimal_places</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;%.</span><span class="si">{</span><span class="n">n_decimal_places</span><span class="si">}</span><span class="s1">f&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="find_all_rows_with_nan"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.find_all_rows_with_nan">[docs]</a><span class="k">def</span> <span class="nf">find_all_rows_with_nan</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">return_indexes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_non_nan_rows</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">return_indexes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_non_nan_rows</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_non_nan_rows</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span></div>
        
<div class="viewcode-block" id="find_all_rows_without_nan"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.find_all_rows_without_nan">[docs]</a><span class="k">def</span> <span class="nf">find_all_rows_without_nan</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">return_indexes</span><span class="o">=</span><span class="kc">True</span><span class="p">,):</span>
    <span class="k">return</span> <span class="n">find_all_rows_with_nan</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">return_indexes</span><span class="o">=</span><span class="n">return_indexes</span><span class="p">,</span>
        <span class="n">return_non_nan_rows</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="filter_away_nan_rows"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.filter_away_nan_rows">[docs]</a><span class="k">def</span> <span class="nf">filter_away_nan_rows</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))]</span></div>
    
<span class="c1">#from IPython.display import display</span>
<div class="viewcode-block" id="display_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.display_df">[docs]</a><span class="k">def</span> <span class="nf">display_df</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="dicts_to_dataframe"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.dicts_to_dataframe">[docs]</a><span class="k">def</span> <span class="nf">dicts_to_dataframe</span><span class="p">(</span><span class="n">list_of_dicts</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">list_of_dicts</span><span class="p">)</span></div>
<span class="n">dicts_to_df</span> <span class="o">=</span> <span class="n">dicts_to_dataframe</span>

<div class="viewcode-block" id="rename_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.rename_columns">[docs]</a><span class="k">def</span> <span class="nf">rename_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">columns_name_map</span><span class="p">,</span><span class="n">in_place</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,):</span>
    <span class="n">return_value</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns_name_map</span><span class="p">,</span><span class="n">inplace</span> <span class="o">=</span> <span class="n">in_place</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">in_place</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">return_value</span></div>

<div class="viewcode-block" id="unique_rows"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.unique_rows">[docs]</a><span class="k">def</span> <span class="nf">unique_rows</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="n">columns</span><span class="p">)</span></div>

<div class="viewcode-block" id="delete_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.delete_columns">[docs]</a><span class="k">def</span> <span class="nf">delete_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">columns_to_delete</span><span class="p">):</span>
    <span class="n">columns_to_delete</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">columns_to_delete</span><span class="p">)</span>
    <span class="n">columns_to_delete</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">columns_to_delete</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns_to_delete</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns_to_delete</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span></div>
    
<span class="c1"># ----------- 1/25 Additon: Used for helping with clustering ----------- #</span>
<span class="c1">#from datasci_tools import numpy_utils as nu</span>
<span class="c1">#import matplotlib.pyplot as plt</span>
<span class="c1">#from . import numpy_dep as np</span>

<div class="viewcode-block" id="divide_dataframe_by_column_value"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.divide_dataframe_by_column_value">[docs]</a><span class="k">def</span> <span class="nf">divide_dataframe_by_column_value</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">return_names</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To divide up the dataframe into </span>
<span class="sd">    multiple dataframes</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    divide_dataframe_by_column_value(non_error_cell,</span>
<span class="sd">                                column=&quot;cell_type_predicted&quot;)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">column</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">table_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">b</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">column</span><span class="p">):</span>
        <span class="n">table_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">return_names</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tables</span><span class="p">,</span><span class="n">table_names</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tables</span></div>
    
<span class="n">divide_df_by_column</span> <span class="o">=</span> <span class="n">divide_dataframe_by_column_value</span>

<div class="viewcode-block" id="split_df_by_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.split_df_by_columns">[docs]</a><span class="k">def</span> <span class="nf">split_df_by_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">columns</span><span class="p">,</span><span class="n">return_names</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">divide_dataframe_by_column_value</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">columns</span><span class="p">,</span><span class="n">return_names</span> <span class="o">=</span> <span class="n">return_names</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="plot_histogram_of_differnt_tables_overlayed"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.plot_histogram_of_differnt_tables_overlayed">[docs]</a><span class="k">def</span> <span class="nf">plot_histogram_of_differnt_tables_overlayed</span><span class="p">(</span><span class="n">tables_to_plot</span><span class="p">,</span>
                          <span class="n">tables_labels</span><span class="p">,</span>
                          <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">fig_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">fig_width</span><span class="o">=</span><span class="mf">18.5</span><span class="p">,</span>
                            <span class="n">fig_height</span> <span class="o">=</span> <span class="mf">10.5</span><span class="p">,</span>
                            <span class="n">n_plots_per_row</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                            <span class="n">n_bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                                           <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Will take multiple</span>
<span class="sd">    tables that all have the same stats and to </span>
<span class="sd">    overlay plot them</span>
<span class="sd">    </span>
<span class="sd">    Ex: plot_histogram_of_differnt_tables_overlayed(non_error_cell,&quot;total&quot;,columns=stats_proj)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nu</span><span class="o">.</span><span class="n">is_array_like</span><span class="p">(</span><span class="n">tables_to_plot</span><span class="p">):</span>
        <span class="n">tables_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="n">tables_to_plot</span><span class="p">]</span>
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nu</span><span class="o">.</span><span class="n">is_array_like</span><span class="p">(</span><span class="n">tables_labels</span><span class="p">):</span>
        <span class="n">tables_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">tables_labels</span><span class="p">]</span>
    
    <span class="n">ex_table</span> <span class="o">=</span> <span class="n">tables_to_plot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cell_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        
    <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span><span class="o">/</span><span class="n">n_plots_per_row</span><span class="p">))</span>
    
    <span class="n">fig</span><span class="p">,</span><span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span><span class="n">n_plots_per_row</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">fig_width</span><span class="p">,</span> <span class="n">fig_height</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fig_title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">fig_title</span><span class="p">)</span>

    
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">col_title</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
        
        <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="n">row</span><span class="o">*</span><span class="mi">4</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">column</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">col_title</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">curr_table</span><span class="p">,</span><span class="n">curr_table_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tables_to_plot</span><span class="p">,</span><span class="n">tables_labels</span><span class="p">):</span>
            <span class="n">curr_data</span> <span class="o">=</span> <span class="n">curr_table</span><span class="p">[</span><span class="n">col_title</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">curr_data</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">curr_table_name</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                    <span class="n">density</span><span class="o">=</span><span class="n">density</span><span class="p">)</span>
            
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="plot_histograms_by_grouping"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.plot_histograms_by_grouping">[docs]</a><span class="k">def</span> <span class="nf">plot_histograms_by_grouping</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
                               <span class="n">column_for_grouping</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    
    <span class="n">dfs</span><span class="p">,</span><span class="n">df_names</span> <span class="o">=</span> <span class="n">divide_dataframe_by_column_value</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
                                <span class="n">column</span><span class="o">=</span><span class="n">column_for_grouping</span><span class="p">,</span>
                                                   <span class="p">)</span>
    
    <span class="n">plot_histogram_of_differnt_tables_overlayed</span><span class="p">(</span><span class="n">tables_to_plot</span><span class="o">=</span><span class="n">dfs</span><span class="p">,</span>
                                               <span class="n">tables_labels</span><span class="o">=</span><span class="n">df_names</span><span class="p">,</span>
                                               <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<div class="viewcode-block" id="new_column_from_row_function"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.new_column_from_row_function">[docs]</a><span class="k">def</span> <span class="nf">new_column_from_row_function</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">row_function</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To create a new column where each </span>
<span class="sd">    row element is a function of the other rows</span>
<span class="sd">    </span>
<span class="sd">    Ex:</span>
<span class="sd">    def synapse_double(row):</span>
<span class="sd">        return row[&quot;synapse_id&quot;]*2</span>

<span class="sd">    new_column_from_row_function(proofreading_synapse_df,synapse_double)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row_function</span><span class="p">(</span><span class="n">row</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="new_column_from_dict_mapping"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.new_column_from_dict_mapping">[docs]</a><span class="k">def</span> <span class="nf">new_column_from_dict_mapping</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">dict_map</span><span class="p">,</span>
    <span class="n">column_name</span><span class="p">,</span>
    <span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If want the same value to exist if not</span>
<span class="sd">    in the dictionary set default_value = &quot;same&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">new_func</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dict_map</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">column_name</span><span class="p">]]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">default_value</span> <span class="o">==</span> <span class="s2">&quot;same&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">default_value</span>
        
    <span class="k">return</span> <span class="n">new_column_from_row_function</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">new_func</span><span class="p">)</span></div>


<div class="viewcode-block" id="reset_index"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.reset_index">[docs]</a><span class="k">def</span> <span class="nf">reset_index</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
    

<span class="c1">#from . import numpy_dep as np</span>
<span class="c1">#import matplotlib.pyplot as plt</span>
<span class="c1">#import six</span>

<div class="viewcode-block" id="df_to_render_table"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.df_to_render_table">[docs]</a><span class="k">def</span> <span class="nf">df_to_render_table</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span> 
    <span class="n">col_width</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> 
    <span class="n">row_height</span><span class="o">=</span><span class="mf">0.625</span><span class="p">,</span> 
    <span class="n">font_size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
    <span class="n">header_color</span><span class="o">=</span><span class="s1">&#39;#40466e&#39;</span><span class="p">,</span> 
    <span class="n">row_colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;#f1f1f2&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">],</span>
    <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span>
    <span class="n">bbox</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">header_columns</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">fontsize_header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">transpose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">float_fmt</span> <span class="o">=</span> <span class="s2">&quot;.3f&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To render a dataframe nicely that can be put in a figure</span>
<span class="sd">    </span>
<span class="sd">    Ex:</span>
<span class="sd">    df = pd.DataFrame()</span>
<span class="sd">    df[&#39;date&#39;] = [&#39;2016-04-01&#39;, &#39;2016-04-02&#39;, &#39;2016-04-03&#39;]</span>
<span class="sd">    df[&#39;calories&#39;] = [2200, 2100, 1500]</span>
<span class="sd">    df[&#39;sleep hours&#39;] = [2200, 2100, 1500]</span>
<span class="sd">    df[&#39;gym&#39;] = [True, False, False]</span>

<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    df_to_render_table(df, header_columns=0, col_width=2.0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_float_fmt</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="s1">:,</span><span class="si">{</span><span class="n">float_fmt</span><span class="si">}</span><span class="se">}}</span><span class="s1">&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;new_float_fmt = </span><span class="si">{</span><span class="n">new_float_fmt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">float_fmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">pu</span><span class="o">.</span><span class="n">float_columns</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="n">new_float_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">))</span>

    
    
    <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">col_width</span><span class="p">,</span> <span class="n">row_height</span><span class="p">])</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">transpose</span><span class="p">:</span>
        <span class="n">mpl_table</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">table</span><span class="p">(</span>
            <span class="n">cellText</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
            <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">,</span> 
            <span class="n">colLabels</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> 
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mpl_table</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">table</span><span class="p">(</span>
            <span class="n">cellText</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
            <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">,</span> 
            <span class="n">rowLabels</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="n">mpl_table</span><span class="o">.</span><span class="n">auto_set_font_size</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">mpl_table</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">font_size</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span>  <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">mpl_table</span><span class="o">.</span><span class="n">_cells</span><span class="p">):</span>
        <span class="n">cell</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="n">edge_color</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">header_columns</span><span class="p">:</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">set_text_props</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize_header</span><span class="p">)</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">header_color</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">row_colors</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">row_colors</span><span class="p">)</span> <span class="p">])</span>
    <span class="k">return</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="example_df_to_render_table"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.example_df_to_render_table">[docs]</a><span class="k">def</span> <span class="nf">example_df_to_render_table</span><span class="p">(</span><span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;index_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stat 1&quot;</span><span class="p">,</span><span class="s2">&quot;stat 2&quot;</span><span class="p">,</span><span class="s2">&quot;stat 3&quot;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2016-04-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2016-04-02&#39;</span><span class="p">,</span> <span class="s1">&#39;2016-04-03&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;calories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2200</span><span class="p">,</span> <span class="mi">2100</span><span class="p">,</span> <span class="mi">1500</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sleep hours&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2200</span><span class="p">,</span> <span class="mi">2100</span><span class="p">,</span> <span class="mi">1500</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gym&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">df_to_render_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">header_columns</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">col_width</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span></div>

<span class="c1">#from pathlib import Path</span>
<div class="viewcode-block" id="save_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.save_df">[docs]</a><span class="k">def</span> <span class="nf">save_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">filename_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>
    <span class="c1">#print(f&quot;{filename_str[-4]}&quot;) </span>
    <span class="k">if</span> <span class="n">filename_str</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">!=</span> <span class="s2">&quot;.pkl&quot;</span><span class="p">:</span>
        <span class="n">filename_str</span> <span class="o">+=</span> <span class="s2">&quot;.pkl&quot;</span>
        
    <span class="n">df</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">filename_str</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="to_pickle"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.to_pickle">[docs]</a><span class="k">def</span> <span class="nf">to_pickle</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pu</span><span class="o">.</span><span class="n">save_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="read_pickle"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.read_pickle">[docs]</a><span class="k">def</span> <span class="nf">read_pickle</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>

<div class="viewcode-block" id="concat"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.concat">[docs]</a><span class="k">def</span> <span class="nf">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<span class="c1">#from pathlib import Path</span>
<div class="viewcode-block" id="df_to_csv"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.df_to_csv">[docs]</a><span class="k">def</span> <span class="nf">df_to_csv</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
              <span class="n">output_filename</span><span class="o">=</span><span class="s2">&quot;df.csv&quot;</span><span class="p">,</span>
              <span class="n">output_folder</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="p">,</span>
              <span class="n">file_suffix</span> <span class="o">=</span> <span class="s2">&quot;.csv&quot;</span><span class="p">,</span>
            <span class="n">output_filepath</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
             <span class="n">return_filepath</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
              <span class="n">compression</span> <span class="o">=</span> <span class="s2">&quot;infer&quot;</span><span class="p">,</span>
              <span class="n">header</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To export a dataframe as a csv</span>
<span class="sd">    file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_folder</span><span class="p">)</span>
        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_filename</span><span class="p">)</span>
        <span class="n">output_filepath</span> <span class="o">=</span> <span class="n">output_folder</span> <span class="o">/</span> <span class="n">output_filename</span>

    <span class="n">output_filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_filepath</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_filepath</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span> <span class="o">!=</span> <span class="n">file_suffix</span><span class="p">:</span>
            <span class="n">output_filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_filepath</span><span class="p">)</span> <span class="o">+</span> <span class="n">file_suffix</span><span class="p">)</span>
    
    <span class="n">output_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_filepath</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output path: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_filepath</span><span class="o">.</span><span class="n">absolute</span><span class="p">()),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span><span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">return_filepath</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">output_path</span></div>

<div class="viewcode-block" id="df_to_gzip"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.df_to_gzip">[docs]</a><span class="k">def</span> <span class="nf">df_to_gzip</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
              <span class="n">output_filename</span><span class="o">=</span><span class="s2">&quot;df.gzip&quot;</span><span class="p">,</span>
              <span class="n">output_folder</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="p">,</span>
            <span class="n">output_filepath</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
             <span class="n">return_filepath</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Save off a compressed version of dataframe</span>
<span class="sd">    (usually 1/3 of the size)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">df_to_csv</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
              <span class="n">output_filename</span><span class="o">=</span><span class="n">output_filename</span><span class="p">,</span>
              <span class="n">output_folder</span> <span class="o">=</span> <span class="n">output_folder</span><span class="p">,</span>
              <span class="n">file_suffix</span> <span class="o">=</span> <span class="s2">&quot;.gzip&quot;</span><span class="p">,</span>
            <span class="n">output_filepath</span> <span class="o">=</span> <span class="n">output_filepath</span><span class="p">,</span>
             <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
             <span class="n">return_filepath</span> <span class="o">=</span> <span class="n">return_filepath</span><span class="p">,</span>
              <span class="n">compression</span> <span class="o">=</span> <span class="s2">&quot;gzip&quot;</span><span class="p">,</span>
             <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">,)</span></div>

<div class="viewcode-block" id="gzip_to_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.gzip_to_df">[docs]</a><span class="k">def</span> <span class="nf">gzip_to_df</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span>
                       <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">error_bad_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

    
<span class="c1">#from . import numpy_dep as np</span>
<div class="viewcode-block" id="filter_away_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.filter_away_columns">[docs]</a><span class="k">def</span> <span class="nf">filter_away_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
                       <span class="n">column_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To filter away certain columns from</span>
<span class="sd">    a dataframe</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    </span>
<span class="sd">    filter_away_columns(proof_with_nucl,</span>
<span class="sd">                       [&quot;id_x&quot;,&quot;pt_position_x&quot;])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">final_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">total_columns</span><span class="p">,</span><span class="n">column_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">final_columns</span><span class="p">]</span></div>


<div class="viewcode-block" id="csv_to_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.csv_to_df">[docs]</a><span class="k">def</span> <span class="nf">csv_to_df</span><span class="p">(</span><span class="n">csv_filepath</span><span class="p">,</span><span class="n">remove_unnamed_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">return_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_filepath</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">remove_unnamed_columns</span><span class="p">:</span>
        <span class="n">return_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">remove_unnamed_columns</span><span class="p">(</span><span class="n">return_df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">return_df</span></div>

<div class="viewcode-block" id="feather_to_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.feather_to_df">[docs]</a><span class="k">def</span> <span class="nf">feather_to_df</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
     <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<span class="n">read_feather</span> <span class="o">=</span> <span class="n">feather_to_df</span>
    
<div class="viewcode-block" id="json_to_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.json_to_df">[docs]</a><span class="k">def</span> <span class="nf">json_to_df</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="n">lines</span><span class="p">)</span> </div>

<div class="viewcode-block" id="extract_arrays_from_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.extract_arrays_from_df">[docs]</a><span class="k">def</span> <span class="nf">extract_arrays_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">column_names</span><span class="o">=</span><span class="s2">&quot;closest_sk_coordinate&quot;</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">,</span><span class="n">n_cols</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="c1">#return np.array([np.array(k,dtype=dtype) for k in df[&quot;closest_sk_coordinate&quot;].to_numpy()]).reshape(-1,n_cols)</span>
    <span class="k">if</span> <span class="n">nu</span><span class="o">.</span><span class="n">is_array_like</span><span class="p">(</span><span class="n">column_names</span><span class="p">):</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_names</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">column_names</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">n_cols</span><span class="p">)</span></div>

<div class="viewcode-block" id="extract_inividual_columns_from_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.extract_inividual_columns_from_df">[docs]</a><span class="k">def</span> <span class="nf">extract_inividual_columns_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">column_names</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">extract_arrays_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">column_names</span><span class="o">=</span><span class="n">column_names</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">T</span></div>

<div class="viewcode-block" id="df_to_list"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.df_to_list">[docs]</a><span class="k">def</span> <span class="nf">df_to_list</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">return_tuples</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">return_tuples</span><span class="p">:</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">vals</span></div>

<div class="viewcode-block" id="columns_values_from_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.columns_values_from_df">[docs]</a><span class="k">def</span> <span class="nf">columns_values_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">columns</span><span class="p">,</span><span class="n">as_array</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Will return the values of columns as seperate variables </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">as_array</span> <span class="k">else</span> <span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span></div>

<div class="viewcode-block" id="datatypes_of_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.datatypes_of_columns">[docs]</a><span class="k">def</span> <span class="nf">datatypes_of_columns</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">auto_proof_df</span><span class="o">.</span><span class="n">dtypes</span></div>

<div class="viewcode-block" id="memory_usage_of_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.memory_usage_of_columns">[docs]</a><span class="k">def</span> <span class="nf">memory_usage_of_columns</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="add_prefix_to_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.add_prefix_to_columns">[docs]</a><span class="k">def</span> <span class="nf">add_prefix_to_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">prefix</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span></div>

<div class="viewcode-block" id="df_from_dict_key_values_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.df_from_dict_key_values_columns">[docs]</a><span class="k">def</span> <span class="nf">df_from_dict_key_values_columns</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span>
                                   <span class="n">columns_names</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;attribute&quot;</span><span class="p">,</span><span class="s2">&quot;description&quot;</span><span class="p">)):</span>
    <span class="n">edge_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                          <span class="nb">list</span><span class="p">(</span><span class="n">data_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">edge_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns_names</span>
    <span class="k">return</span> <span class="n">edge_df</span></div>

<div class="viewcode-block" id="set_pd_max_row_col"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.set_pd_max_row_col">[docs]</a><span class="k">def</span> <span class="nf">set_pd_max_row_col</span><span class="p">(</span><span class="n">max_rows</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">max_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="n">max_rows</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="n">max_cols</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="set_pd_display_no_truncate"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.set_pd_display_no_truncate">[docs]</a><span class="k">def</span> <span class="nf">set_pd_display_no_truncate</span><span class="p">():</span>
    <span class="n">pu</span><span class="o">.</span><span class="n">set_pd_max_row_col</span><span class="p">()</span></div>
<div class="viewcode-block" id="set_pd_display_no_truncate_col"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.set_pd_display_no_truncate_col">[docs]</a><span class="k">def</span> <span class="nf">set_pd_display_no_truncate_col</span><span class="p">():</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="reset_pd_display"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.reset_pd_display">[docs]</a><span class="k">def</span> <span class="nf">reset_pd_display</span><span class="p">():</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">reset_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">reset_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">reset_option</span><span class="p">(</span><span class="s1">&#39;display.width&#39;</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">reset_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">reset_option</span><span class="p">(</span><span class="s1">&#39;display.max_colwidth&#39;</span><span class="p">)</span></div>
    
<span class="c1">#from datasci_tools.tqdm_utils import tqdm</span>
<div class="viewcode-block" id="flatten_nested_dict_df_slow"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.flatten_nested_dict_df_slow">[docs]</a><span class="k">def</span> <span class="nf">flatten_nested_dict_df_slow</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Will faltten a dataframe if columns contain nested dicts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dicts</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">dataframe_to_row_dicts</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">dicts_flattened</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dicts</span><span class="p">):</span>
        <span class="n">curr_flat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dicts_flattened</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_flat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">dicts_flattened</span><span class="p">)</span></div>

<span class="c1">#import time</span>
<span class="c1">#import json</span>
<div class="viewcode-block" id="flatten_nested_dict_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.flatten_nested_dict_df">[docs]</a><span class="k">def</span> <span class="nf">flatten_nested_dict_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">json_struct</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">))</span>    
    <span class="n">df_flat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">json_struct</span><span class="p">)</span> <span class="c1">#use pd.io.json</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;flattening df time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_flat</span></div>


<div class="viewcode-block" id="col_to_numeric_array"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.col_to_numeric_array">[docs]</a><span class="k">def</span> <span class="nf">col_to_numeric_array</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">col_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: to output a column as a numeric array</span>
<span class="sd">    (will account for coersion)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="convert_columns_to_numeric"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.convert_columns_to_numeric">[docs]</a><span class="k">def</span> <span class="nf">convert_columns_to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        
    <span class="k">return</span> <span class="n">df</span></div>

<span class="c1">#from functools import reduce</span>
<div class="viewcode-block" id="restrict_df_by_dict"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.restrict_df_by_dict">[docs]</a><span class="k">def</span> <span class="nf">restrict_df_by_dict</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">dict_restriction</span><span class="p">,</span><span class="n">return_indexes</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="n">y</span><span class="p">,</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">dict_restriction</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
    <span class="k">if</span> <span class="n">return_indexes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="fillna"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.fillna">[docs]</a><span class="k">def</span> <span class="nf">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">({</span><span class="n">k</span><span class="p">:</span><span class="n">value</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">})</span></div>

<div class="viewcode-block" id="column_data_types"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.column_data_types">[docs]</a><span class="k">def</span> <span class="nf">column_data_types</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">dtypes</span></div>
<div class="viewcode-block" id="filter_away_columns_by_data_type"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.filter_away_columns_by_data_type">[docs]</a><span class="k">def</span> <span class="nf">filter_away_columns_by_data_type</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
                                     <span class="n">data_type</span> <span class="o">=</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                                    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
        <span class="n">cols_to_inspect</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">]</span>
        <span class="n">cols_to_delete</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols_to_inspect</span><span class="p">:</span>
            <span class="n">curr_col</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="n">curr_col</span> <span class="o">=</span> <span class="n">curr_col</span><span class="p">[</span><span class="o">~</span><span class="n">curr_col</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr_col</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">curr_col</span><span class="o">.</span><span class="n">infer_objects</span><span class="p">()</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2"> should be filtered away&quot;</span><span class="p">)</span>
                    <span class="n">cols_to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pu</span><span class="o">.</span><span class="n">delete_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">cols_to_delete</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">!=</span> <span class="n">data_type</span><span class="p">]]</span></div>

<span class="c1">#from datasci_tools import numpy_utils as nu</span>
<div class="viewcode-block" id="duplicated_col_value_rows"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.duplicated_col_value_rows">[docs]</a><span class="k">def</span> <span class="nf">duplicated_col_value_rows</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">col</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ex:</span>
<span class="sd">    df_test = pd.DataFrame.from_records([</span>
<span class="sd">    dict(x=5,y=7,z=10),</span>
<span class="sd">    dict(x=5,y=7,z=12),</span>
<span class="sd">    dict(x=5,y=6,z=10)</span>
<span class="sd">    ])</span>

<span class="sd">    pu.duplicated_col_value_rows(df_test,col=[&quot;x&quot;,&quot;z&quot;])</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">col</span><span class="p">,</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span></div>

<span class="n">repeated_col_value_rows</span> <span class="o">=</span> <span class="n">duplicated_col_value_rows</span>

<div class="viewcode-block" id="filter_away_rows_with_duplicated_col_value"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.filter_away_rows_with_duplicated_col_value">[docs]</a><span class="k">def</span> <span class="nf">filter_away_rows_with_duplicated_col_value</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">col</span><span class="p">,</span>
    <span class="p">):</span>
    
    <span class="n">col</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">col</span><span class="p">,</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span></div>


<div class="viewcode-block" id="filter_to_extrema_k_of_group"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.filter_to_extrema_k_of_group">[docs]</a><span class="k">def</span> <span class="nf">filter_to_extrema_k_of_group</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">group_columns</span><span class="p">,</span>
    <span class="n">sort_columns</span><span class="p">,</span>
    <span class="n">k</span><span class="p">,</span>
    <span class="n">extrema</span> <span class="o">=</span> <span class="s2">&quot;largest&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">extrema</span> <span class="o">==</span> <span class="s1">&#39;largest&#39;</span><span class="p">:</span>
        <span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">extrema</span> <span class="o">==</span> <span class="s1">&#39;smallest&#39;</span><span class="p">:</span>
        <span class="n">ascending</span> <span class="o">=</span> <span class="kc">True</span>
        
    <span class="n">df_sort</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">sort_df_by_column</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span><span class="n">sort_columns</span><span class="p">,</span>
        <span class="n">ascending</span><span class="o">=</span><span class="n">ascending</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_columns</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">k</span><span class="p">)</span></div>

<div class="viewcode-block" id="filter_to_first_k_of_group"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.filter_to_first_k_of_group">[docs]</a><span class="k">def</span> <span class="nf">filter_to_first_k_of_group</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">group_columns</span><span class="p">,</span>
    <span class="n">sort_columns</span><span class="p">,</span>
    <span class="n">k</span><span class="p">,</span>
    <span class="p">):</span>
    
    <span class="k">return</span> <span class="n">filter_to_extrema_k_of_group</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">group_columns</span><span class="o">=</span><span class="n">group_columns</span><span class="p">,</span>
    <span class="n">sort_columns</span><span class="o">=</span><span class="n">sort_columns</span><span class="p">,</span>
    <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
    <span class="n">extrema</span> <span class="o">=</span> <span class="s2">&quot;largest&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="filter_to_first_instance_of_unique_column"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.filter_to_first_instance_of_unique_column">[docs]</a><span class="k">def</span> <span class="nf">filter_to_first_instance_of_unique_column</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column_name</span><span class="p">,</span>
    <span class="n">reset_index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,):</span>
    <span class="n">column_name</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">column_name</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Before filtering for unique </span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">return_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">column_name</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AFTER filtering for unique </span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">return_df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">reset_index</span><span class="p">:</span>
        <span class="n">return_df</span> <span class="o">=</span> <span class="n">return_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">return_df</span></div>

<div class="viewcode-block" id="filter_df_rows_with_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.filter_df_rows_with_df">[docs]</a><span class="k">def</span> <span class="nf">filter_df_rows_with_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">df_filter</span><span class="p">):</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_filter</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">i1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
    <span class="n">i2</span> <span class="o">=</span> <span class="n">df_filter</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">i1</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">i2</span><span class="p">)]</span></div>

<div class="viewcode-block" id="combine_columns_as_str"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.combine_columns_as_str">[docs]</a><span class="k">def</span> <span class="nf">combine_columns_as_str</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">columns</span><span class="p">,</span>
    <span class="n">join_str</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
    <span class="p">):</span>
    
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">join_str</span><span class="o">.</span><span class="n">join</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<span class="c1">#from datasci_tools import general_utils as gu</span>
<div class="viewcode-block" id="filter_away_characters_from_column"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.filter_away_characters_from_column">[docs]</a><span class="k">def</span> <span class="nf">filter_away_characters_from_column</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">characters_to_filter</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="s2">&quot;/&quot;</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To filter out certain characters of a column</span>
<span class="sd">    values </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">column</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">column</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">elim_func</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">gu</span><span class="o">.</span><span class="n">str_filter_away_characters</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">c</span><span class="p">],</span><span class="n">characters_to_filter</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>

        <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">new_column_from_row_function</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span>
            <span class="n">elim_func</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="remove_unnamed_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.remove_unnamed_columns">[docs]</a><span class="k">def</span> <span class="nf">remove_unnamed_columns</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;^Unnamed&#39;</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="normalize_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.normalize_df">[docs]</a><span class="k">def</span> <span class="nf">normalize_df</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column_means</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">column_stds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">in_place</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To normalize a pandas table with</span>
<span class="sd">    means and standard deviations of the columns</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">column_means</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">column_means</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">column_stds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">column_stds</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="n">norm_columns</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">-</span><span class="n">column_means</span><span class="p">)</span><span class="o">/</span><span class="n">column_stds</span>
    <span class="k">if</span> <span class="n">in_place</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm_columns</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">norm_columns</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">normalized_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">normalized_df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">=</span><span class="n">norm_columns</span>
            <span class="k">return</span> <span class="n">normalized_df</span></div>

<div class="viewcode-block" id="normalize_df_with_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.normalize_df_with_df">[docs]</a><span class="k">def</span> <span class="nf">normalize_df_with_df</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">df_norm</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To normalize a dataframe with</span>
<span class="sd">    another dataframe</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Get the columns of dataframe</span>
<span class="sd">    2) Use the columns of df to restrict the normalization df</span>
<span class="sd">    3) Get the column means and standard deviations</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">df_standardization</span> <span class="o">=</span> <span class="n">df_norm</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">col_means</span> <span class="o">=</span> <span class="n">df_standardization</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;norm_mean&quot;</span><span class="p">,:]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">col_means</span> <span class="o">=</span> <span class="n">df_standardization</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">col_stds</span> <span class="o">=</span> <span class="n">df_standardization</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;norm_std&quot;</span><span class="p">,:]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">col_stds</span> <span class="o">=</span> <span class="n">df_standardization</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;col_means = </span><span class="si">{</span><span class="n">col_means</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;col_stds = </span><span class="si">{</span><span class="n">col_stds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1">#raise Exception(&quot;&quot;)</span>
    <span class="k">return</span> <span class="n">pu</span><span class="o">.</span><span class="n">normalize_df</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">column_means</span> <span class="o">=</span> <span class="n">col_means</span><span class="p">,</span>
        <span class="n">column_stds</span> <span class="o">=</span> <span class="n">col_stds</span><span class="p">,)</span></div>

<div class="viewcode-block" id="normalize_df_with_names"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.normalize_df_with_names">[docs]</a><span class="k">def</span> <span class="nf">normalize_df_with_names</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">col_means</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">col_stds</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">df_standardization</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">col_means</span><span class="p">,</span><span class="n">col_stds</span><span class="p">]),</span>
         <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;norm_mean&quot;</span><span class="p">,</span><span class="s2">&quot;norm_std&quot;</span><span class="p">],</span>
        <span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_standardization</span></div>

<span class="c1"># Filter away rows with infinity</span>
<div class="viewcode-block" id="filter_away_non_finite_rows"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.filter_away_non_finite_rows">[docs]</a><span class="k">def</span> <span class="nf">filter_away_non_finite_rows</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span></div>

<div class="viewcode-block" id="replace_None_with_default"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.replace_None_with_default">[docs]</a><span class="k">def</span> <span class="nf">replace_None_with_default</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pu</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">default</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span></div>

<div class="viewcode-block" id="replace_nan_with_default"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.replace_nan_with_default">[docs]</a><span class="k">def</span> <span class="nf">replace_nan_with_default</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">default</span><span class="p">)</span></div>

<div class="viewcode-block" id="set_column_value_of_query"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.set_column_value_of_query">[docs]</a><span class="k">def</span> <span class="nf">set_column_value_of_query</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">column</span><span class="p">,</span><span class="n">query</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Set colum value of query</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="group_by_func_to_column_old"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.group_by_func_to_column_old">[docs]</a><span class="k">def</span> <span class="nf">group_by_func_to_column_old</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">columns</span><span class="p">,</span>
    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">add_to_original_df</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">function_name</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span>
    <span class="p">):</span>
    <span class="n">dum_col</span><span class="o">=</span> <span class="s2">&quot;xnusid&quot;</span>
    <span class="n">df</span><span class="p">[</span><span class="n">dum_col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">rename_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">columns</span><span class="p">),</span><span class="n">function_name</span><span class="p">)()[[</span><span class="n">dum_col</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">rename_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">(</span><span class="n">rename_df</span><span class="p">,{</span><span class="n">dum_col</span><span class="p">:</span><span class="n">name</span><span class="p">})</span>
    

    <span class="k">if</span> <span class="n">add_to_original_df</span><span class="p">:</span>
        <span class="n">rename_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">rename_df</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dum_col</span> <span class="ow">in</span> <span class="n">rename_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">rename_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">delete_columns</span><span class="p">(</span><span class="n">rename_df</span><span class="p">,[</span><span class="n">dum_col</span><span class="p">])</span>
        
    <span class="k">return</span> <span class="n">rename_df</span></div>

<div class="viewcode-block" id="group_by_func_to_column_slow"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.group_by_func_to_column_slow">[docs]</a><span class="k">def</span> <span class="nf">group_by_func_to_column_slow</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">columns</span><span class="p">,</span>
    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">add_to_original_df</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">function_name</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span>
    <span class="p">):</span>
    <span class="n">dum_col</span><span class="o">=</span> <span class="s2">&quot;xnusid&quot;</span>
    <span class="n">df</span><span class="p">[</span><span class="n">dum_col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">rename_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">columns</span><span class="p">),</span><span class="n">function_name</span><span class="p">)()[[</span><span class="n">dum_col</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">rename_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">(</span><span class="n">rename_df</span><span class="p">,{</span><span class="n">dum_col</span><span class="p">:</span><span class="n">name</span><span class="p">})</span>
    

    <span class="k">if</span> <span class="n">add_to_original_df</span><span class="p">:</span>
        <span class="n">rename_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">rename_df</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dum_col</span> <span class="ow">in</span> <span class="n">rename_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">rename_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">delete_columns</span><span class="p">(</span><span class="n">rename_df</span><span class="p">,[</span><span class="n">dum_col</span><span class="p">])</span>
        
    <span class="k">return</span> <span class="n">rename_df</span></div>

<div class="viewcode-block" id="group_by_func_to_column"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.group_by_func_to_column">[docs]</a><span class="k">def</span> <span class="nf">group_by_func_to_column</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">columns</span><span class="p">,</span>
    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">add_to_original_df</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">function_name</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span>
    <span class="p">):</span>
    <span class="n">dum_col</span><span class="o">=</span> <span class="s2">&quot;xnusid&quot;</span>
    <span class="n">df</span><span class="p">[</span><span class="n">dum_col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">rename_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns</span> <span class="o">+</span> <span class="p">[</span><span class="n">dum_col</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">rename_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">(</span><span class="n">rename_df</span><span class="p">,{</span><span class="n">dum_col</span><span class="p">:</span><span class="n">name</span><span class="p">})</span>
    

    <span class="k">if</span> <span class="n">add_to_original_df</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rename_df</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">rename_df</span> <span class="o">=</span> <span class="n">df</span>

    <span class="k">if</span> <span class="n">dum_col</span> <span class="ow">in</span> <span class="n">rename_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">rename_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">delete_columns</span><span class="p">(</span><span class="n">rename_df</span><span class="p">,[</span><span class="n">dum_col</span><span class="p">])</span>
        
    <span class="k">return</span> <span class="n">rename_df</span></div>


<div class="viewcode-block" id="drop_rows_with_all_nans"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.drop_rows_with_all_nans">[docs]</a><span class="k">def</span> <span class="nf">drop_rows_with_all_nans</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="sample_rows"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.sample_rows">[docs]</a><span class="k">def</span> <span class="nf">sample_rows</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">n_samples</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">n_samples</span><span class="p">:</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span></div>

<div class="viewcode-block" id="sample_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.sample_columns">[docs]</a><span class="k">def</span> <span class="nf">sample_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">n_samples</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="expand_array_column_to_separate_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.expand_array_column_to_separate_columns">[docs]</a><span class="k">def</span> <span class="nf">expand_array_column_to_separate_columns</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">columns</span><span class="p">,</span>
    <span class="n">use_previous_column_name</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Will expand a column that has an array stored in each</span>
<span class="sd">    row to moving the values to each with its own column</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    from datasci_tools import pandas_utils as pu</span>
<span class="sd">    pu.expand_array_column_to_separate_columns(</span>
<span class="sd">    use_previous_column_name = False,</span>
<span class="sd">    columns = &quot;embedding&quot;,</span>
<span class="sd">    df = df_old,</span>
<span class="sd">    )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>

        <span class="n">sub_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">use_previous_column_name</span><span class="p">:</span>
            <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">sub_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))]</span>
            <span class="n">sub_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">column_names</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span><span class="n">sub_df</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">delete_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">column</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="sort_df_by_column"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.sort_df_by_column">[docs]</a><span class="k">def</span> <span class="nf">sort_df_by_column</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">columns</span><span class="p">,</span>
    <span class="n">ignore_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">na_position</span> <span class="o">=</span> <span class="s2">&quot;last&quot;</span> <span class="c1">#where to put the nans</span>
    <span class="p">):</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
                         <span class="n">ascending</span><span class="o">=</span><span class="n">ascending</span><span class="p">,</span>
                          <span class="n">ignore_index</span><span class="o">=</span><span class="n">ignore_index</span><span class="p">,</span>
                         <span class="n">na_position</span> <span class="o">=</span> <span class="n">na_position</span><span class="p">)</span></div>


<div class="viewcode-block" id="histogram_of_discrete_labels"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.histogram_of_discrete_labels">[docs]</a><span class="k">def</span> <span class="nf">histogram_of_discrete_labels</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">y</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span>
    <span class="n">x_steps</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">step_size</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nbins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">cumulative</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">normalize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">add_counts</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">max_percentile</span> <span class="o">=</span> <span class="mi">99</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To create a cumulative or discrete</span>
<span class="sd">    df of discrete values accordinate to another</span>
<span class="sd">    indexing value</span>

<span class="sd">    Ex: </span>
<span class="sd">    pu.histogram_of_discrete_labels(</span>
<span class="sd">        df_centr_sort,</span>
<span class="sd">        y=&quot;cell_type&quot;,</span>
<span class="sd">        normalize=False,</span>
<span class="sd">        cumulative=False</span>
<span class="sd">    )</span>
<span class="sd">    </span>
<span class="sd">    Ex 2: </span>
<span class="sd">    from neurd import cell_type_utils as ctu</span>
<span class="sd">    df_counts = pu.histogram_of_discrete_labels(</span>
<span class="sd">        df_centr_sort,</span>
<span class="sd">        y=&quot;cell_type_fine&quot;,</span>
<span class="sd">        normalize=True,</span>
<span class="sd">        cumulative=True,</span>
<span class="sd">        x_steps = np.linspace(0,1000,100),</span>
<span class="sd">        plot = True,</span>
<span class="sd">        color_dict = ctu.cell_type_fine_color_map,</span>
<span class="sd">        set_legend_outside_plot = True,</span>

<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="n">x_range</span> <span class="o">=</span> <span class="n">x_steps</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">==</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">all_ys</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">all_ys</span> <span class="o">=</span> <span class="n">all_ys</span><span class="p">[</span><span class="n">all_ys</span> <span class="o">!=</span> <span class="s2">&quot;index&quot;</span><span class="p">]</span>
    
    
    <span class="n">x_vals</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">max_percentile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_value</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span><span class="n">max_percentile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_value</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_vals</span><span class="p">):</span>
            <span class="n">max_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">max_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All labels = </span><span class="si">{</span><span class="n">all_ys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">x_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">step_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_vals</span><span class="p">),</span><span class="n">max_value</span><span class="p">,</span><span class="n">nbins</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_vals</span><span class="p">),</span><span class="n">max_value</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span><span class="n">step_size</span><span class="p">)</span>
    
    
    
    <span class="n">counts_records</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1">#     print(f&quot;len(df) = {len(df)}&quot;)</span>
<span class="c1">#     print(f&quot;x_range = {x_range}&quot;)</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">x_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="n">x_lower</span> <span class="o">=</span> <span class="n">x_range</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">x_middle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">x_val</span><span class="p">,</span><span class="n">x_lower</span><span class="p">])</span>
        <span class="c1">#print(f&quot;x_middle = {x_middle}&quot;)</span>

        <span class="n">local_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x_middle</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cumulative</span><span class="p">:</span>
            <span class="n">x_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_range</span><span class="p">)</span>

        <span class="n">df_curr</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> &gt;= </span><span class="si">{</span><span class="n">x_lower</span><span class="si">}</span><span class="s2">) and (</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> &lt;= </span><span class="si">{</span><span class="n">x_val</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="c1">#print(f&quot;df_curr = {len(df_curr)}&quot;)</span>

        <span class="n">total_counts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_curr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_counts</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">lab</span> <span class="ow">in</span> <span class="n">all_ys</span><span class="p">:</span>
            <span class="n">curr_counts</span> <span class="o">=</span> <span class="n">df_curr</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2"> == &#39;</span><span class="si">{</span><span class="n">lab</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                <span class="n">local_dict</span><span class="p">[</span><span class="n">lab</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr_counts</span><span class="p">)</span>  <span class="o">/</span> <span class="n">total_counts</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">local_dict</span><span class="p">[</span><span class="n">lab</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr_counts</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">add_counts</span><span class="p">:</span>
            <span class="n">local_dict</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_counts</span>
            
        <span class="c1">#print(f&quot;total_counts = {total_counts}&quot;)</span>

        <span class="n">counts_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_dict</span><span class="p">)</span>

    <span class="n">df_counts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">counts_records</span><span class="p">)</span>
    <span class="c1">#print(f&quot;df_counts = {len(df_counts)}&quot;)</span>
    
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">datasci_tools</span> <span class="kn">import</span> <span class="n">matplotlib_utils</span> <span class="k">as</span> <span class="n">mu</span>
        <span class="n">mu</span><span class="o">.</span><span class="n">stacked_bar_graph</span><span class="p">(</span>
           <span class="n">df_counts</span><span class="p">,</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">df_counts</span></div>

<div class="viewcode-block" id="unique_row_counts"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.unique_row_counts">[docs]</a><span class="k">def</span> <span class="nf">unique_row_counts</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">count_column_name</span> <span class="o">=</span> <span class="s2">&quot;unique_counts&quot;</span><span class="p">,</span>
    <span class="n">add_to_df</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To determine the counts of the </span>
<span class="sd">    number of unique rows as determined by the columns</span>
<span class="sd">    (and could add the number to the dataframe)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unique_df</span> <span class="o">=</span> <span class="n">df</span>
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="n">columns</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>

    <span class="n">count_column</span> <span class="o">=</span> <span class="n">count_column_name</span>
    <span class="n">unique_df</span><span class="p">[</span><span class="n">count_column</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">counts_df</span> <span class="o">=</span> <span class="n">unique_df</span><span class="p">[</span><span class="n">columns</span> <span class="o">+</span> <span class="p">[</span><span class="n">count_column</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of unique rows = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">counts_df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">add_to_df</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">pu</span><span class="o">.</span><span class="n">delete_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">count_column</span><span class="p">),</span>
            <span class="n">counts_df</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">counts_df</span></div>
    
<div class="viewcode-block" id="set_max_colwidth"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.set_max_colwidth">[docs]</a><span class="k">def</span> <span class="nf">set_max_colwidth</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">400</span><span class="p">):</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;max_colwidth&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span></div>
    
<span class="c1">#from datasci_tools import numpy_utils as nu</span>
<div class="viewcode-block" id="filter_df_by_column_percentile"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.filter_df_by_column_percentile">[docs]</a><span class="k">def</span> <span class="nf">filter_df_by_column_percentile</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">percentile_buffer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">percentile_lower</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">percentile_upper</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To filter a dataframe for</span>
<span class="sd">    a certain percentile range</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    pu.filter_df_by_column_percentile(</span>
<span class="sd">        df_to_plot,</span>
<span class="sd">        &quot;n_syn_soma_no_label_postsyn&quot;,</span>
<span class="sd">        percentile_buffer = 5,</span>
<span class="sd">        verbose = True</span>
<span class="sd">    )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns</span><span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">percentile_lower</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">percentile_buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">percentile_lower</span> <span class="o">=</span> <span class="n">percentile_buffer</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">percentile_lower</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">if</span> <span class="n">percentile_upper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">percentile_buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">percentile_upper</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="n">percentile_buffer</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">percentile_upper</span> <span class="o">=</span> <span class="mi">100</span>
            
    
    <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">att_vals</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s2"> == </span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">attribute</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">min_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">att_vals</span><span class="p">,</span><span class="n">percentile_lower</span><span class="p">)</span>
        <span class="n">max_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">att_vals</span><span class="p">,</span><span class="n">percentile_upper</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;outlier processing: min_value = </span><span class="si">{</span><span class="n">min_value</span><span class="si">}</span><span class="s2">, max_value = </span><span class="si">{</span><span class="n">max_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">original_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">&gt;=</span><span class="si">{</span><span class="n">min_value</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; and (</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">&lt;=</span><span class="si">{</span><span class="n">max_value</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After filtering df by column </span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">: reduced from </span><span class="si">{</span><span class="n">original_size</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> entries&quot;</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">df</span></div>

<span class="n">percentile_filter</span> <span class="o">=</span> <span class="n">filter_df_by_column_percentile</span>

<div class="viewcode-block" id="filter_away_rows_with_nan_in_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.filter_away_rows_with_nan_in_columns">[docs]</a><span class="k">def</span> <span class="nf">filter_away_rows_with_nan_in_columns</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">columns</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To filter away rows that have</span>
<span class="sd">    a nan value in certain columns</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="n">columns</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    
    <span class="n">df_curr</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">find_all_rows_without_nan</span><span class="p">(</span>
        <span class="n">df_curr</span><span class="p">,</span><span class="n">return_indexes</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">df_filt</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">,:]</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtering </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_filt</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">df_filt</span> <span class="o">=</span> <span class="n">df_filt</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">==</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df_filt</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="k">return</span> <span class="n">df_filt</span></div>

<div class="viewcode-block" id="filter_away_rows_with_nan_only_in_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.filter_away_rows_with_nan_only_in_columns">[docs]</a><span class="k">def</span> <span class="nf">filter_away_rows_with_nan_only_in_columns</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">columns</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,):</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Before nan filtering in columns: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">==</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-&gt; After nan filtering in columns: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span></div>
    
<div class="viewcode-block" id="filter_away_rows_with_inf_only_in_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.filter_away_rows_with_inf_only_in_columns">[docs]</a><span class="k">def</span> <span class="nf">filter_away_rows_with_inf_only_in_columns</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">columns</span><span class="p">,</span>
    <span class="n">in_place</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,):</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Before inf filtering in columns: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_place</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
    <span class="n">df_filt</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">find_all_rows_without_nan</span><span class="p">(</span><span class="n">df_filt</span><span class="p">)</span>
    <span class="n">df_filt</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">,:]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df_filt</span> <span class="o">=</span> <span class="n">df_filt</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-&gt; After inf filtering in columns: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_filt</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df_filt</span></div>

<div class="viewcode-block" id="filter_away_rows_with_inf_or_nan_only_in_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.filter_away_rows_with_inf_or_nan_only_in_columns">[docs]</a><span class="k">def</span> <span class="nf">filter_away_rows_with_inf_or_nan_only_in_columns</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">columns</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">filter_away_rows_with_nan_only_in_columns</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">filter_away_rows_with_inf_only_in_columns</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="randomly_sample_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.randomly_sample_df">[docs]</a><span class="k">def</span> <span class="nf">randomly_sample_df</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">n_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,):</span>
    
    <span class="c1">#print(f&quot;seed = {seed}&quot;)</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">n_samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">n_samples</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span> <span class="ow">and</span> <span class="n">replace</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of samples greater than df length so just returning df&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">randomly_sample_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)),</span><span class="n">n_samples</span><span class="p">,</span><span class="n">replace</span> <span class="o">=</span> <span class="n">replace</span><span class="p">)</span>
    <span class="n">restricted_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">,:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">restricted_df</span></div>

<div class="viewcode-block" id="shuffle_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.shuffle_df">[docs]</a><span class="k">def</span> <span class="nf">shuffle_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pu</span><span class="o">.</span><span class="n">randomly_sample_df</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<span class="c1">#from datasci_tools import general_utils as gu</span>
<div class="viewcode-block" id="expand_array_column_to_separate_rows"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.expand_array_column_to_separate_rows">[docs]</a><span class="k">def</span> <span class="nf">expand_array_column_to_separate_rows</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">array_columns</span><span class="p">,</span>
    <span class="n">scalar_columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: to take columns that have arrays stored in them and turn them</span>
<span class="sd">    into rows, add on the scalar rows if requested</span>
<span class="sd">    </span>
<span class="sd">    Ex:</span>
<span class="sd">    import pandas as pd</span>
<span class="sd">    array_columns = [&quot;spine_intervals_1&quot;,&quot;spine_intervals_2&quot;]</span>
<span class="sd">    scalar_columns = [&quot;compartment&quot;,&quot;n_spine&quot;,&quot;segment_id&quot;,&quot;width&quot;]</span>

<span class="sd">    out_df = pu.expand_array_column_to_separate_rows(</span>
<span class="sd">        df = inter_attr_df,</span>
<span class="sd">        array_columns=array_columns,</span>
<span class="sd">        scalar_columns=scalar_columns</span>
<span class="sd">    )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">array_columns</span><span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">array_columns</span><span class="p">)</span>

    <span class="n">curr_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">array_columns</span><span class="p">}</span>
    <span class="n">dtype_map</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">scalar_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">first_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">curr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">scalar_columns</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">scalar_columns</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scalar_columns</span><span class="p">:</span>
            <span class="n">curr_data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span><span class="n">curr_data</span><span class="p">[</span><span class="n">first_key</span><span class="p">])]</span>
            <span class="n">dtype_map</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
            
        <span class="c1">#return curr_data</span>

    <span class="n">curr_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span><span class="n">gu</span><span class="o">.</span><span class="n">combine_list_of_lists</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span>
                      <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">curr_data</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">curr_data</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">set_column_datatypes</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">dtype_map</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="set_column_datatypes"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.set_column_datatypes">[docs]</a><span class="k">def</span> <span class="nf">set_column_datatypes</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">datatype_map</span><span class="p">):</span>
    
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">datatype_map</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="is_column_numeric"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.is_column_numeric">[docs]</a><span class="k">def</span> <span class="nf">is_column_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">column</span><span class="p">):</span>
    <span class="k">if</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span> <span class="ow">or</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>
    
<div class="viewcode-block" id="normalize_rows_by_sum"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.normalize_rows_by_sum">[docs]</a><span class="k">def</span> <span class="nf">normalize_rows_by_sum</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">fillna_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">percentage</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To divide the rows of a dataframe by the sum  </span>
<span class="sd">    of the rows</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">fillna_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">fillna_value</span><span class="p">)</span>
    
    <span class="n">divisor</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">percentage</span><span class="p">:</span>
        <span class="n">divisor</span> <span class="o">=</span> <span class="n">divisor</span><span class="o">/</span><span class="mi">100</span>
        
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">divisor</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="concat_dfs_without_duplicates"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.concat_dfs_without_duplicates">[docs]</a><span class="k">def</span> <span class="nf">concat_dfs_without_duplicates</span><span class="p">(</span>
    <span class="n">dfs</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Want to do a concatenate on a list as long as </span>
<span class="sd">    there are no repeats in certain columns beforehand</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1)concatenate the dataframes and reset the index</span>
<span class="sd">    2) drop the duplicates (after restricting to certain columns)</span>
<span class="sd">    3) Get the indexes of the dropped duplicates and use that to restrict the concatenated dataframe</span>
<span class="sd">    4) Reset the index and return</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_combined</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;str&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">columns</span><span class="p">)):</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">columns</span><span class="p">]</span>

    <span class="n">unique_df</span> <span class="o">=</span> <span class="n">df_combined</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
    <span class="n">final_df</span> <span class="o">=</span> <span class="n">df_combined</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">unique_df</span><span class="o">.</span><span class="n">index</span><span class="p">,:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of duplicate rows = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_combined</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">final_df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final_df</span></div>

<div class="viewcode-block" id="is_dataframe"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.is_dataframe">[docs]</a><span class="k">def</span> <span class="nf">is_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span></div>
<div class="viewcode-block" id="is_series"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.is_series">[docs]</a><span class="k">def</span> <span class="nf">is_series</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span></div>

<span class="c1">#from datasci_tools import numpy_utils as nu</span>
<span class="c1">#from datasci_tools import pandas_utils as pu</span>

<div class="viewcode-block" id="summary_statistic_over_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.summary_statistic_over_columns">[docs]</a><span class="k">def</span> <span class="nf">summary_statistic_over_columns</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">columns</span><span class="p">,</span>
    <span class="n">summary_statistic</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">summary_statisic_args</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    
    <span class="c1">#for the naming</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">append_statistic_name</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">special_count_name</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    
    <span class="c1"># for outputting</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_df</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">debug_time</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To compute a summary statistic for columns </span>
<span class="sd">    over all rows of dataframe</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    from datasci_tools import pandas_utils as pu</span>
<span class="sd">    pu.summary_statistic_over_columns(</span>
<span class="sd">        columns = [&quot;n_synapses&quot;],#[&quot;&quot;,&quot;n_synapses_pre&quot;],</span>
<span class="sd">        df = node_df,</span>
<span class="sd">        summary_statistic = &quot;percentile&quot;,</span>
<span class="sd">        summary_statisic_args = 99,</span>
<span class="sd">        verbose = True,</span>
<span class="sd">        return_df = False,</span>
<span class="sd">    append_statistic_name = True</span>
<span class="sd">    )</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="n">singular_flag</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">default_column</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">default_column</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">default_column</span> <span class="o">=</span> <span class="kc">None</span>
        
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nu</span><span class="o">.</span><span class="n">is_array_like</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">singular_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">columns</span><span class="p">]</span>
        
    <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="c1">#print(f&quot;columns before reduction = {columns}&quot;)</span>
    <span class="c1"># only keep the columns that are in df</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="c1">#print(f&quot;   -&gt; columns after reduction = {columns}&quot;)</span>
    
    <span class="n">node_df_restr</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">summary_statisic_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">summary_statisic_args</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">summary_statisic_args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">summary_statisic_args</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">summary_statistic</span> <span class="o">==</span> <span class="s2">&quot;percentile&quot;</span><span class="p">:</span>
        <span class="n">summary_statistic</span> <span class="o">=</span> <span class="s2">&quot;quantile&quot;</span>
        <span class="k">if</span> <span class="n">summary_statisic_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">summary_statisic_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">/</span><span class="mi">100</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">]</span>
                                    <span class="k">else</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">summary_statisic_args</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;summary_statistic = </span><span class="si">{</span><span class="n">summary_statistic</span><span class="si">}</span><span class="se">\n</span><span class="s2">   -&gt; summary_statisic_args = </span><span class="si">{</span><span class="n">summary_statisic_args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">summary_statistic</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
        <span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">nu</span><span class="o">.</span><span class="n">average_by_weights</span><span class="p">(</span><span class="n">node_df_restr</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                                                          <span class="n">weights</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">weight</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
                                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">],</span>
                               <span class="n">index</span> <span class="o">=</span> <span class="n">columns</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">summary_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node_df_restr</span><span class="p">,</span><span class="n">summary_statistic</span><span class="p">)(</span><span class="o">*</span><span class="n">summary_statisic_args</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">debug_time</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time for computing summary statistic = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    
    <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">summary_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">summary_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        
    <span class="k">if</span> <span class="n">append_statistic_name</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">summary_statistic</span> <span class="o">==</span> <span class="s2">&quot;count&quot;</span> <span class="ow">and</span> <span class="n">special_count_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">summary_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;n_</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">summary_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;n_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">summary_df</span><span class="o">.</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">summary_statistic</span><span class="si">}{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">summary_statisic_args</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span> 
                              <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
            
    <span class="k">if</span> <span class="n">default_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">summary_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">default_column</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span>
                            <span class="n">default_column</span> <span class="k">else</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">summary_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">default_column</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span>
                            <span class="n">default_column</span> <span class="k">else</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">summary_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span>
                     <span class="k">else</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        
    <span class="k">if</span> <span class="n">summary_statistic</span> <span class="o">==</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span>
        <span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">debug_time</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fixing the names = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
            
    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_df</span><span class="p">:</span>
        <span class="n">return_dicts</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">df_to_dicts</span><span class="p">(</span><span class="n">summary_df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">singular_flag</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">return_dicts</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">return_dicts</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">summary_df</span></div>
    
    
<span class="c1">#from datasci_tools import numpy_utils as nu</span>
<div class="viewcode-block" id="summary_statistics_over_columns_by_category"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.summary_statistics_over_columns_by_category">[docs]</a><span class="k">def</span> <span class="nf">summary_statistics_over_columns_by_category</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">category_columns</span><span class="p">,</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">attribute_summary_dicts</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">add_counts_summary</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">special_count_name</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">debug_time</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    summary_statistics_over_columns_by_category()</span>

<span class="sd">    def </span>

<span class="sd">    Purpose: Want to compute a bunch </span>
<span class="sd">    of category counts/or statistic</span>
<span class="sd">    of certain columns</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Create a dataframe of the attribute</span>
<span class="sd">    2) Get all the possible combinations of restrictions for categories</span>
<span class="sd">    3) </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    node_dict = G.nodes[&quot;L1_2&quot;]</span>
<span class="sd">    attribute = &quot;synapse_data&quot;</span>
<span class="sd">    prefix = &quot;synapse&quot;</span>
<span class="sd">    df = pd.DataFrame.from_records(node_dict[attribute])</span>

<span class="sd">    pu.summary_statistics_over_columns_by_category(</span>
<span class="sd">        df,</span>
<span class="sd">        prefix = &quot;synapse&quot;,</span>
<span class="sd">        category_columns = [&quot;head_neck_shaft&quot;,&quot;syn_type&quot;],</span>
<span class="sd">        attribute_summary_dicts = [dict(columns=&quot;volume&quot;,</span>
<span class="sd">                                       summary_statistic = &quot;sum&quot;,</span>
<span class="sd">                                        summary_statisic_args = None)],</span>
<span class="sd">        add_counts_summary = True,</span>
<span class="sd">        verbose = False,</span>
<span class="sd">        special_count_name = True,</span>

<span class="sd">    )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">attribute_summary_dicts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">attribute_summary_dicts</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">attribute_summary_dicts</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">attribute_summary_dicts</span> <span class="o">=</span> <span class="p">[</span><span class="n">attribute_summary_dicts</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">add_counts_summary</span><span class="p">:</span>
        <span class="n">attribute_summary_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">summary_statistic</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span><span class="p">)</span>
        <span class="p">)</span>


    <span class="n">category_combinations</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">category_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">category_columns_revised</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">category_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">category_columns_revised</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No column </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> for category&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">category_columns_revised</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">category_columns</span> <span class="o">=</span> <span class="n">category_columns_revised</span>
            <span class="n">category_columns</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">category_columns</span><span class="p">)</span>
            <span class="n">category_attributes_pos</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
                                      <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">category_columns</span><span class="p">]</span>
            <span class="n">category_combinations</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">all_combinations_of_lists</span><span class="p">(</span><span class="o">*</span><span class="n">category_attributes_pos</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;category_combinations = </span><span class="si">{</span><span class="n">category_combinations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">category_columns</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
            
    <span class="k">if</span> <span class="n">debug_time</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time for combinations = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    

    <span class="n">results_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">curr_restr</span> <span class="ow">in</span> <span class="n">category_combinations</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">-- Working on curr_restr = </span><span class="si">{</span><span class="n">curr_restr</span><span class="si">}</span><span class="s2">--&quot;</span><span class="p">)</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">curr_restr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">curr_df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">queries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">category_columns</span><span class="p">,</span><span class="n">curr_restr</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> == &#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">curr_df</span> <span class="o">=</span> <span class="n">df</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">total_query</span> <span class="o">=</span> <span class="s2">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total_query = </span><span class="si">{</span><span class="n">total_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">curr_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">total_query</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  len(df) </span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">debug_time</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time for query = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># compute the statistics over the current dataframe</span>
        <span class="k">for</span> <span class="n">stat_dict</span> <span class="ow">in</span> <span class="n">attribute_summary_dicts</span><span class="p">:</span>
            <span class="n">summary_statisic_args</span> <span class="o">=</span> <span class="n">stat_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary_statisic_args&quot;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">summary_statistic</span> <span class="o">=</span> <span class="n">stat_dict</span><span class="p">[</span><span class="s2">&quot;summary_statistic&quot;</span><span class="p">]</span>
            <span class="n">columns</span><span class="o">=</span> <span class="n">stat_dict</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>

            <span class="n">results</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">summary_statistic_over_columns</span><span class="p">(</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span><span class="p">,</span><span class="c1">#[&quot;&quot;,&quot;n_synapses_pre&quot;],</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">curr_df</span><span class="p">,</span>
                <span class="n">summary_statistic</span> <span class="o">=</span> <span class="n">summary_statistic</span><span class="p">,</span>
                <span class="n">summary_statisic_args</span> <span class="o">=</span> <span class="n">summary_statisic_args</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">return_df</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">append_statistic_name</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix</span><span class="p">,</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span><span class="p">,</span>
                <span class="n">special_count_name</span><span class="o">=</span><span class="n">special_count_name</span><span class="p">,</span>
                <span class="n">debug_time</span><span class="o">=</span><span class="n">debug_time</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">debug_time</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time for summary_statistic_over_columns = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="n">results_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results_dict</span></div>

<div class="viewcode-block" id="example_Series"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.example_Series">[docs]</a><span class="k">def</span> <span class="nf">example_Series</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="mi">2255</span><span class="p">,</span><span class="mi">81</span><span class="p">],</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;n_synapses&quot;</span><span class="p">,</span><span class="s1">&#39;n_synapses_pre&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="df_from_array"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.df_from_array">[docs]</a><span class="k">def</span> <span class="nf">df_from_array</span><span class="p">(</span>
    <span class="n">array</span><span class="p">,</span>
    <span class="n">columns</span><span class="p">,</span>
    <span class="n">inf_fill_value</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="p">):</span>
    
    <span class="n">df_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="n">df_temp</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span>
    <span class="k">if</span> <span class="n">inf_fill_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df_temp</span><span class="o">=</span><span class="n">df_temp</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span><span class="n">inf_fill_value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_temp</span></div>

<div class="viewcode-block" id="filter_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.filter_columns">[docs]</a><span class="k">def</span> <span class="nf">filter_columns</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">columns_to_delete</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To filter columns</span>
<span class="sd">    of dataframe for those specified to keep</span>
<span class="sd">    and those specified to delete</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    pu.filter_columns(</span>
<span class="sd">        normalization_df,</span>
<span class="sd">        #columns_to_keep = [&quot;skeletal_length&quot;,&#39;skeleton_vector_upstream_theta&#39;],</span>
<span class="sd">        columns_to_delete=[&quot;skeletal_length&quot;]</span>
<span class="sd">    )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">columns_to_keep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">columns_to_keep</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span>
        
    <span class="k">if</span> <span class="n">columns_to_delete</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns_to_delete</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">columns_to_delete</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">delete_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">columns_to_delete</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="set_column_subset_value_by_query"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.set_column_subset_value_by_query">[docs]</a><span class="k">def</span> <span class="nf">set_column_subset_value_by_query</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">query</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">column_for_value</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">function_for_value</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">in_place</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Set column</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_place</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">curr_map</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of rows in query = </span><span class="si">{</span><span class="n">curr_map</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr_map</span><span class="p">,</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">elif</span> <span class="n">function_for_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr_map</span><span class="p">,</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">function_for_value</span><span class="p">(</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">,</span>
            <span class="n">idx_map</span> <span class="o">=</span> <span class="n">curr_map</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">column_for_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr_map</span><span class="p">,</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr_map</span><span class="p">,</span><span class="n">column_for_value</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr_map</span><span class="p">,</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="count_unique_column_values"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.count_unique_column_values">[docs]</a><span class="k">def</span> <span class="nf">count_unique_column_values</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">sort</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">count_column_name</span> <span class="o">=</span> <span class="s2">&quot;unique_counts&quot;</span><span class="p">,</span>
    <span class="n">add_percentage</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,):</span>
    <span class="n">column</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">column</span><span class="p">))</span>
    <span class="n">return_df</span> <span class="o">=</span>  <span class="n">pu</span><span class="o">.</span><span class="n">unique_row_counts</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">],</span><span class="n">count_column_name</span><span class="o">=</span><span class="n">count_column_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
        <span class="n">return_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">sort_df_by_column</span><span class="p">(</span><span class="n">return_df</span><span class="p">,</span><span class="n">count_column_name</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">add_percentage</span><span class="p">:</span>
        <span class="n">return_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">add_percentage_column</span><span class="p">(</span><span class="n">return_df</span><span class="p">,</span><span class="n">column</span> <span class="o">=</span> <span class="n">count_column_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">return_df</span></div>

<div class="viewcode-block" id="add_percentage_column"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.add_percentage_column">[docs]</a><span class="k">def</span> <span class="nf">add_percentage_column</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">percentage_column</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1"># &quot;percentage&quot;</span>
    <span class="p">):</span>
    
    <span class="k">if</span> <span class="n">percentage_column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">percentage_column</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;percentage (</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">)&quot;</span>
        
    <span class="n">df</span><span class="p">[</span><span class="n">percentage_column</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span></div>
    

<span class="c1">#from datasci_tools import numpy_utils as nu</span>
<div class="viewcode-block" id="intersect_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.intersect_columns">[docs]</a><span class="k">def</span> <span class="nf">intersect_columns</span><span class="p">(</span><span class="n">dfs</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">nu</span><span class="o">.</span><span class="n">intersect1d_multi_list</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">]))</span></div>

<div class="viewcode-block" id="intersect_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.intersect_df">[docs]</a><span class="k">def</span> <span class="nf">intersect_df</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">df_restr</span><span class="p">,</span>
    <span class="n">restriction_columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">append_restr_columns</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">reset_index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To get the intersection of two dataframes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">restriction_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">restriction_columns</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">intersect_columns</span><span class="p">([</span><span class="n">df</span><span class="p">,</span><span class="n">df_restr</span><span class="p">])</span>
        
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;restriction_columns= </span><span class="si">{</span><span class="n">restriction_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">append_restr_columns</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_restr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">restriction_columns</span>
        
    <span class="n">restr_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">df_restr</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="n">restriction_columns</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">reset_index</span><span class="p">:</span>
        <span class="n">restr_df</span> <span class="o">=</span> <span class="n">restr_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Before df restricting (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Length of df after restriction using (</span><span class="si">{</span><span class="n">restriction_columns</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">restr_df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">restr_df</span></div>

<div class="viewcode-block" id="setdiff_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.setdiff_df">[docs]</a><span class="k">def</span> <span class="nf">setdiff_df</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">df_restr</span><span class="p">,</span>
    <span class="n">restriction_columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reset_index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">inter_df</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To find subtract the </span>
<span class="sd">    rows of one dataframe from the other</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">restriction_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">restriction_columns</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">intersect_columns</span><span class="p">([</span><span class="n">df</span><span class="p">,</span><span class="n">df_restr</span><span class="p">])</span>
        
    <span class="k">if</span> <span class="n">inter_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">inter_df</span> <span class="o">=</span> <span class="n">intersect_df</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span>
            <span class="n">df_restr</span><span class="p">,</span>
            <span class="n">restriction_columns</span> <span class="o">=</span> <span class="n">restriction_columns</span><span class="p">,</span>
            <span class="n">append_restr_columns</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">reset_index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
    
    <span class="n">diff_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
        <span class="n">inter_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
        <span class="p">),:]</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Length of df after restriction using (</span><span class="si">{</span><span class="n">restriction_columns</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">diff_df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">reset_index</span><span class="p">:</span>
        <span class="n">diff_df</span> <span class="o">=</span> <span class="n">diff_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">diff_df</span></div>

<div class="viewcode-block" id="split_df_from_intersect_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.split_df_from_intersect_df">[docs]</a><span class="k">def</span> <span class="nf">split_df_from_intersect_df</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">df_restr</span><span class="p">,</span>
    <span class="n">restriction_columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">append_restr_columns</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">reset_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To Split a table using a restriction df</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inter_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">intersect_df</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">df_restr</span><span class="p">,</span>
        <span class="n">restriction_columns</span> <span class="o">=</span> <span class="n">restriction_columns</span><span class="p">,</span>
        <span class="n">append_restr_columns</span> <span class="o">=</span> <span class="n">append_restr_columns</span><span class="p">,</span>
        <span class="n">reset_index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    
    <span class="n">diff_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">setdiff_df</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">df_restr</span><span class="p">,</span>
        <span class="n">restriction_columns</span> <span class="o">=</span> <span class="n">restriction_columns</span><span class="p">,</span>
        <span class="n">reset_index</span> <span class="o">=</span> <span class="n">reset_index</span><span class="p">,</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">inter_df</span> <span class="o">=</span> <span class="n">inter_df</span><span class="p">,</span>
        <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">reset_index</span><span class="p">:</span>
        <span class="n">inter_df</span> <span class="o">=</span> <span class="n">inter_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inter_df size = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">inter_df</span><span class="p">)</span><span class="si">}</span><span class="s2">, diff_df = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">diff_df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">inter_df</span><span class="p">,</span><span class="n">diff_df</span></div>
    
<div class="viewcode-block" id="split_str_column_into_multple"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.split_str_column_into_multple">[docs]</a><span class="k">def</span> <span class="nf">split_str_column_into_multple</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">column</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">,</span><span class="n">expand</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="excel_to_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.excel_to_df">[docs]</a><span class="k">def</span> <span class="nf">excel_to_df</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> </div>

<div class="viewcode-block" id="bin_df_by_column"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.bin_df_by_column">[docs]</a><span class="k">def</span> <span class="nf">bin_df_by_column</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">n_bins</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_bins</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_bins_midpoints</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">equal_depth_bins</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">percentile_upper</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To calculate sub dataframe</span>
<span class="sd">    after binning a certain column</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">percentile_upper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">filter_df_by_column_percentile</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">column</span><span class="p">,</span>
            <span class="n">percentile_lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">percentile_upper</span><span class="o">=</span><span class="n">percentile_upper</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
    

    <span class="k">if</span> <span class="n">bins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">equal_depth_bins</span><span class="p">:</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">equal_depth_bins</span><span class="p">(</span>
                <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                <span class="n">n_bins</span> <span class="o">=</span> <span class="n">n_bins</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#bins = np.linspace(0,df[column].max(),n_bins + 1)</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">equal_width_bins</span><span class="p">(</span>
                <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                <span class="n">n_bins</span> <span class="o">=</span> <span class="n">n_bins</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bins = </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">final_comp</span> <span class="o">=</span> <span class="s2">&quot;&lt;=&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_comp</span> <span class="o">=</span> <span class="s2">&quot;&lt;&quot;</span>

        <span class="n">query_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2"> &gt;= </span><span class="si">{</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">) and (</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">final_comp</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">curr_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query_str</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For bin </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, query_str = </span><span class="si">{</span><span class="n">query_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   -&gt; length of sub df = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_df</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">return_bins</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">return_bins_midpoints</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">df_list</span>
    <span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_list</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">return_bins</span><span class="p">:</span>
        <span class="n">return_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_bins_midpoints</span><span class="p">:</span>
        <span class="n">return_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nu</span><span class="o">.</span><span class="n">midpoints_from_array</span><span class="p">(</span><span class="n">bins</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">return_value</span></div>

<div class="viewcode-block" id="bin_df_by_column_stat"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.bin_df_by_column_stat">[docs]</a><span class="k">def</span> <span class="nf">bin_df_by_column_stat</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">func</span><span class="p">,</span>
    <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">equal_depth_bins</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">percentile_upper</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_bins</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose_bins</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_bins</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">return_bins_mid</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">bins_mid_type</span> <span class="o">=</span> <span class="s2">&quot;min_max_mean&quot;</span><span class="p">,</span><span class="c1">#weighted</span>
    <span class="n">return_df_len</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">return_std</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">func_std</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">plot_n_data_points</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">plot_errorbars</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: to compute a statistic over</span>
<span class="sd">    binned sub dfs (where bins are determined by column)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">twin_color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">20</span>

        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">df_bins</span><span class="p">,</span><span class="n">bins</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">bin_df_by_column</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
        <span class="n">column</span><span class="o">=</span><span class="n">column</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
        <span class="n">n_bins</span> <span class="o">=</span> <span class="n">n_bins</span><span class="p">,</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
        <span class="n">return_bins</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">equal_depth_bins</span><span class="o">=</span><span class="n">equal_depth_bins</span><span class="p">,</span>
        <span class="n">percentile_upper</span><span class="o">=</span><span class="n">percentile_upper</span><span class="p">,</span>
        <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose_bins</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bins = </span><span class="si">{</span><span class="n">bins</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">curr_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="n">func</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df_bins</span><span class="p">]</span>
        <span class="n">df_stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">curr_values</span><span class="p">]</span>
        <span class="n">df_std</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">curr_values</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df_bins</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">func_std</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_std</span> <span class="o">=</span> <span class="p">[</span><span class="n">func_std</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df_bins</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_std</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">df_len</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df_bins</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">bins_mid_type</span> <span class="o">==</span> <span class="s2">&quot;min_max_mean&quot;</span><span class="p">:</span>
        <span class="n">mid_bins</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">elif</span> <span class="n">bins_mid_type</span> <span class="o">==</span> <span class="s2">&quot;weighted&quot;</span><span class="p">:</span>
        <span class="n">mid_bins</span> <span class="o">=</span> <span class="p">[</span><span class="n">curr_df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">curr_df</span> <span class="ow">in</span> <span class="n">df_bins</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        
        <span class="c1">#ax.plot(mid_bins,df_stats,)</span>
        <span class="k">if</span> <span class="n">df_std</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">plot_errorbars</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mid_bins</span><span class="p">,</span><span class="n">df_stats</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">mid_bins</span><span class="p">,</span><span class="n">df_stats</span><span class="p">,</span><span class="n">yerr</span> <span class="o">=</span> <span class="n">df_std</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_n_data_points</span><span class="p">:</span> <span class="c1">#and not equal_depth_bins:</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>  <span class="c1"># instantiate a second axes that shares the same x-axis</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;# of Data Points&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">twin_color</span><span class="p">)</span>  <span class="c1"># we already handled the x-label with ax1</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="n">twin_color</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mid_bins</span><span class="p">,</span> <span class="n">df_len</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">twin_color</span><span class="p">)</span>
        <span class="c1">#plt.show()</span>
        
        <span class="k">if</span> <span class="n">return_plot</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ax</span>

    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">return_bins</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">return_df_len</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">return_std</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">df_stats</span>
    <span class="n">return_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_stats</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">return_bins_mid</span><span class="p">:</span>
        <span class="n">return_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mid_bins</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">return_bins</span><span class="p">:</span>
        <span class="n">return_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_df_len</span><span class="p">:</span>
        <span class="n">return_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_len</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">return_std</span><span class="p">:</span>
        <span class="n">return_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_std</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">return_list</span></div>

<div class="viewcode-block" id="empty_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.empty_df">[docs]</a><span class="k">def</span> <span class="nf">empty_df</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Create an empty dataframe</span>
<span class="sd">    with certain columns</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="n">k</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">})</span></div>



<span class="c1">#from datasci_tools import numpy_utils as nu</span>
<div class="viewcode-block" id="merge_df_to_source_target"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.merge_df_to_source_target">[docs]</a><span class="k">def</span> <span class="nf">merge_df_to_source_target</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">df_append</span><span class="p">,</span>
    <span class="n">source_name</span> <span class="o">=</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span>
    <span class="n">target_name</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span>
    <span class="n">append_type</span> <span class="o">=</span> <span class="s2">&quot;prefix&quot;</span><span class="p">,</span>
    <span class="n">on</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">how</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">in_place</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: merge a dataframe to </span>
<span class="sd">    a dataframe with a directional column</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_append</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_place</span><span class="p">:</span>
        <span class="c1">#print(f&quot;Trying to copy&quot;)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="n">source_name</span><span class="p">,</span><span class="n">target_name</span><span class="p">]:</span>
<span class="c1">#         if append_type == &quot;prefix&quot;:</span>
<span class="c1">#             name_str = &#39;f&quot;{kk}_{v}&quot;&#39;</span>
<span class="c1">#         elif append_type == &quot;suffix&quot;:</span>
<span class="c1">#             name_str = &#39;f&quot;{v}_{kk}&quot;&#39;</span>
<span class="c1">#         elif append_type is None:</span>
<span class="c1">#             name_str = &#39;f&quot;{kk}&quot;&#39;</span>
<span class="c1">#         else:</span>
<span class="c1">#             raise Exception(&quot;&quot;)</span>

        <span class="n">name_str</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">append_type</span> <span class="o">==</span> <span class="s2">&quot;prefix&quot;</span><span class="p">:</span>
                <span class="n">name_str</span> <span class="o">=</span> <span class="s1">&#39;f&quot;</span><span class="si">{kk}</span><span class="s1">_</span><span class="si">{v}</span><span class="s1">&quot;&#39;</span>
            <span class="k">elif</span> <span class="n">append_type</span> <span class="o">==</span> <span class="s2">&quot;suffix&quot;</span><span class="p">:</span>
                <span class="n">name_str</span> <span class="o">=</span> <span class="s1">&#39;f&quot;</span><span class="si">{v}</span><span class="s1">_</span><span class="si">{kk}</span><span class="s1">&quot;&#39;</span>
            <span class="k">elif</span> <span class="n">append_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">name_str</span> <span class="o">=</span> <span class="s1">&#39;f&quot;</span><span class="si">{kk}</span><span class="s1">&quot;&#39;</span>
        
        
        <span class="k">if</span> <span class="n">name_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name_str</span> <span class="o">=</span> <span class="s1">&#39;f&quot;</span><span class="si">{v}</span><span class="s1">&quot;&#39;</span>
            <span class="c1">#raise Exception(&quot;&quot;)</span>

        
        <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span><span class="nb">eval</span><span class="p">(</span><span class="n">name_str</span><span class="p">)</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">),</span><span class="n">columns</span><span class="p">)}</span>
        
        
        <span class="k">if</span> <span class="n">on</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">curr_on</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rename_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">on</span><span class="p">),</span><span class="nb">list</span><span class="p">(</span><span class="n">rename_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">curr_on</span> <span class="o">=</span> <span class="n">k</span>
                <span class="n">rename_dict</span><span class="p">[</span><span class="n">on</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
                
        <span class="c1">#print(f&quot;rename_dict = {rename_dict}&quot;)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">return_value</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">df</span><span class="p">,</span>
                <span class="n">pu</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">(</span><span class="n">df_append</span><span class="p">[</span><span class="n">columns</span><span class="p">],</span>
                                  <span class="n">rename_dict</span><span class="p">,</span>
                                 <span class="n">in_place</span> <span class="o">=</span> <span class="n">in_place</span><span class="p">),</span>
                <span class="n">on</span><span class="o">=</span><span class="n">curr_on</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="n">how</span><span class="p">,</span>
                <span class="n">copy</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">in_place</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">rename_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">v</span><span class="p">:</span><span class="nb">eval</span><span class="p">(</span><span class="n">name_str</span><span class="p">)</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">k</span><span class="p">],[</span><span class="n">on</span><span class="p">])})</span>
            <span class="n">curr_on</span> <span class="o">=</span> <span class="n">rename_dict</span><span class="p">[</span><span class="n">on</span><span class="p">]</span>
            
            <span class="n">return_value</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">df</span><span class="p">,</span>
                <span class="n">pu</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">(</span><span class="n">df_append</span><span class="p">[</span><span class="n">columns</span><span class="p">],</span>
                                  <span class="n">rename_dict</span><span class="p">,</span>
                                      <span class="n">in_place</span> <span class="o">=</span> <span class="n">in_place</span><span class="p">),</span>
                <span class="n">on</span><span class="o">=</span><span class="n">curr_on</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="n">how</span><span class="p">,</span>
                <span class="n">copy</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">in_place</span><span class="p">,</span>
            <span class="p">)</span>
            
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_place</span> <span class="ow">or</span> <span class="n">return_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">return_value</span>
        <span class="c1">#print(f&quot;df.columns = {df.columns}&quot;)</span>
        <span class="c1">#print(f&quot;return_value.columns = {return_value.columns}&quot;)</span>
            
    <span class="k">return</span> <span class="n">df</span></div>

<span class="n">append_df_to_source_target</span> <span class="o">=</span> <span class="n">merge_df_to_source_target</span>

<div class="viewcode-block" id="df_to_index_dict"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.df_to_index_dict">[docs]</a><span class="k">def</span> <span class="nf">df_to_index_dict</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">columns_to_export</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To convert a pandas dataframe</span>
<span class="sd">    to just one dictionary indexed by the index</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        
    <span class="n">keys</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">columns_to_export</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns_to_export</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns_to_export</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">my_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span><span class="n">values</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">my_dict</span></div>

<div class="viewcode-block" id="coordinate_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.coordinate_columns">[docs]</a><span class="k">def</span> <span class="nf">coordinate_columns</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;synapse&quot;</span><span class="p">,</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;nm&quot;</span><span class="p">,</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;z&quot;</span><span class="p">),</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
    
    <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">a</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span>
        <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;columns = </span><span class="si">{</span><span class="n">columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">columns</span></div>

<div class="viewcode-block" id="coordinates_from_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.coordinates_from_df">[docs]</a><span class="k">def</span> <span class="nf">coordinates_from_df</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;synapse&quot;</span><span class="p">,</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;nm&quot;</span><span class="p">,</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;z&quot;</span><span class="p">),</span>
    <span class="n">filter_away_nans</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
    
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">coordinate_columns</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix</span><span class="p">,</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">,</span>
        <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">filter_away_nans</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">filter_away_rows_with_nan_in_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span></div>
    
    
<div class="viewcode-block" id="flatten_column_multi_index"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.flatten_column_multi_index">[docs]</a><span class="k">def</span> <span class="nf">flatten_column_multi_index</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">join_str</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="p">):</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">join_str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_flat_index</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="flatten_row_multi_index"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.flatten_row_multi_index">[docs]</a><span class="k">def</span> <span class="nf">flatten_row_multi_index</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span></div>

<span class="c1">#from . import numpy_dep as np</span>
<div class="viewcode-block" id="restrict_df_to_coordinates_within_radius_old"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.restrict_df_to_coordinates_within_radius_old">[docs]</a><span class="k">def</span> <span class="nf">restrict_df_to_coordinates_within_radius_old</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">center</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">,</span>
    <span class="n">within_radius</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;nm&quot;</span><span class="p">,</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">),</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Restrict df by radius and a center point</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    from datasci_tools import pandas_utils as pu</span>

<span class="sd">    center_df = hdju.seg_split_centroid(</span>
<span class="sd">        table = hdju.proofreading_neurons_with_gnn_cell_type_fine,</span>
<span class="sd">        features = [</span>
<span class="sd">            &quot;gnn_cell_type_coarse&quot;,</span>
<span class="sd">            &quot;gnn_cell_type_fine&quot;,</span>
<span class="sd">            &quot;cell_type&quot;</span>
<span class="sd">        ],</span>
<span class="sd">        return_df = True,</span>
<span class="sd">    )</span>

<span class="sd">    pu.restrict_df_to_coordinates_within_radius(</span>
<span class="sd">        center_df,</span>
<span class="sd">        name = &quot;centroid&quot;,</span>
<span class="sd">        center = [861471,976721,896473],</span>
<span class="sd">        radius = 100_000</span>
<span class="sd">    )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">coordinates_from_df</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">coords</span><span class="o">-</span><span class="n">center</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">within_radius</span><span class="p">:</span>
        <span class="n">idx_map</span> <span class="o">=</span> <span class="n">dists</span> <span class="o">&lt;=</span> <span class="n">radius</span>
        <span class="n">descr</span> <span class="o">=</span> <span class="s2">&quot;inside&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">idx_map</span> <span class="o">=</span> <span class="n">dists</span> <span class="o">&gt;=</span> <span class="n">radius</span>
        <span class="n">descr</span> <span class="o">=</span> <span class="s2">&quot;outside&quot;</span>
        
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of records </span><span class="si">{</span><span class="n">descr</span><span class="si">}</span><span class="s2"> radius (</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idx_map</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx_map</span><span class="p">,:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<span class="c1"># ------------- datajoint and pandas interface -------</span>
<span class="c1">#from datasci_tools import regex_utils as reu</span>

<div class="viewcode-block" id="table_type_from_table"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.table_type_from_table">[docs]</a><span class="k">def</span> <span class="nf">table_type_from_table</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pu</span><span class="o">.</span><span class="n">is_dataframe</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;pandas&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;datajoint&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">table</span><span class="p">)):</span>
        <span class="k">return</span> <span class="s2">&quot;dj&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="query_str_from_list"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.query_str_from_list">[docs]</a><span class="k">def</span> <span class="nf">query_str_from_list</span><span class="p">(</span>
    <span class="n">restrictions</span><span class="p">,</span>
    <span class="n">table_type</span><span class="o">=</span><span class="s2">&quot;dj&quot;</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">joiner</span> <span class="o">=</span> <span class="s2">&quot;AND&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To turn any list of restrictions into a restriction str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">restrictions</span><span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">restrictions</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">restrictions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">table_type</span> <span class="o">==</span> <span class="s2">&quot;dj&quot;</span><span class="p">:</span>
        <span class="n">restrictions</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;==&quot;</span><span class="p">,</span><span class="s2">&quot;=&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">restrictions</span><span class="p">]</span>
        <span class="n">joiner</span> <span class="o">=</span> <span class="n">joiner</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">restrictions</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; = &quot;</span><span class="p">,</span><span class="s2">&quot; == &quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">restrictions</span> <span class="p">]</span>
        <span class="n">joiner</span> <span class="o">=</span> <span class="n">joiner</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="n">restr_str</span> <span class="o">=</span> <span class="n">joiner</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">restrictions</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;query_str = </span><span class="si">{</span><span class="n">restr_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">restr_str</span></div>

<div class="viewcode-block" id="query_str"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.query_str">[docs]</a><span class="k">def</span> <span class="nf">query_str</span><span class="p">(</span><span class="n">restrictions</span><span class="p">,</span>
    <span class="n">table_type</span><span class="o">=</span><span class="s2">&quot;dj&quot;</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">joiner</span> <span class="o">=</span> <span class="s2">&quot;AND&quot;</span><span class="p">):</span>
    
    <span class="n">restrictions</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">restrictions</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">query_str_from_list</span><span class="p">(</span>
        <span class="n">restrictions</span><span class="p">,</span>
        <span class="n">table_type</span><span class="o">=</span><span class="n">table_type</span><span class="p">,</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
        <span class="n">joiner</span> <span class="o">=</span> <span class="n">joiner</span><span class="p">,</span>
    <span class="p">)</span></div>

<span class="n">restriction_str_from_list</span> <span class="o">=</span> <span class="n">query_str_from_list</span>

<span class="n">dj_to_pandas_query_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot; = &quot;</span><span class="p">:</span><span class="s2">&quot; == &quot;</span><span class="p">,</span><span class="s2">&quot;AND&quot;</span><span class="p">:</span><span class="s2">&quot;and&quot;</span><span class="p">,</span><span class="s2">&quot;OR&quot;</span><span class="p">:</span><span class="s2">&quot;or&quot;</span><span class="p">,</span><span class="s2">&quot;NOT&quot;</span><span class="p">:</span><span class="s2">&quot;not&quot;</span><span class="p">,</span><span class="s2">&quot;SQRT&quot;</span><span class="p">:</span><span class="s2">&quot;sqrt&quot;</span><span class="p">}</span>
<div class="viewcode-block" id="pandas_query_str_from_query_str"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.pandas_query_str_from_query_str">[docs]</a><span class="k">def</span> <span class="nf">pandas_query_str_from_query_str</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To replace a query of another form (usually datajoint query)</span>
<span class="sd">    to a pandas query</span>
<span class="sd">    </span>
<span class="sd">    Pseudocode:</span>
<span class="sd">    1) For all of the joiners (and, or, not), convert to lowercase</span>
<span class="sd">    2) convert the &#39; = &#39; to double equal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">reu</span><span class="o">.</span><span class="n">multiple_replace</span><span class="p">(</span>
        <span class="n">query</span><span class="p">,</span>
        <span class="n">dj_to_pandas_query_map</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="datajoint_query_str_from_query_str"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.datajoint_query_str_from_query_str">[docs]</a><span class="k">def</span> <span class="nf">datajoint_query_str_from_query_str</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">reu</span><span class="o">.</span><span class="n">multiple_replace</span><span class="p">(</span>
        <span class="n">query</span><span class="p">,</span>
        <span class="p">{</span><span class="n">v</span><span class="p">:</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">dj_to_pandas_query_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="query_str_from_type"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.query_str_from_type">[docs]</a><span class="k">def</span> <span class="nf">query_str_from_type</span><span class="p">(</span>
    <span class="n">query</span><span class="p">,</span>
    <span class="n">table_type</span> <span class="o">=</span> <span class="s2">&quot;pandas&quot;</span>
    <span class="p">):</span>
    
    <span class="k">if</span> <span class="n">table_type</span> <span class="o">==</span> <span class="s2">&quot;pandas&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pu</span><span class="o">.</span><span class="n">pandas_query_str_from_query_str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">table_type</span> <span class="o">==</span> <span class="s1">&#39;dj&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pu</span><span class="o">.</span><span class="n">datajoint_query_str_from_query_str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="query_table_from_query_str"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.query_table_from_query_str">[docs]</a><span class="k">def</span> <span class="nf">query_table_from_query_str</span><span class="p">(</span>
    <span class="n">table</span><span class="p">,</span>
    <span class="n">query</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">pu</span><span class="o">.</span><span class="n">is_dataframe</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">query_str_from_type</span><span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="n">table_type</span> <span class="o">=</span> <span class="s1">&#39;pandas&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">query_str_from_type</span><span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="n">table_type</span> <span class="o">=</span> <span class="s1">&#39;dj&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">table</span> <span class="o">&amp;</span> <span class="n">query</span></div>
    
<span class="n">restrict_df_from_str</span> <span class="o">=</span> <span class="n">query_table_from_query_str</span>
    
<div class="viewcode-block" id="query_table_from_list"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.query_table_from_list">[docs]</a><span class="k">def</span> <span class="nf">query_table_from_list</span><span class="p">(</span>
    <span class="n">table</span><span class="p">,</span>
    <span class="n">restrictions</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose_filtering</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">joiner</span> <span class="o">=</span> <span class="s2">&quot;AND&quot;</span><span class="p">,</span>
    <span class="n">return_idx</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
    
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">restrictions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">table</span>

    <span class="n">table_type</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">table_type_from_table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">query_str_from_list</span><span class="p">(</span>
        <span class="n">restrictions</span><span class="p">,</span>
        <span class="n">table_type</span><span class="o">=</span><span class="n">table_type</span><span class="p">,</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
        <span class="n">joiner</span><span class="o">=</span><span class="n">joiner</span><span class="p">,)</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">return_df</span> <span class="o">=</span>  <span class="n">pu</span><span class="o">.</span><span class="n">query_table_from_query_str</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">query</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose_filtering</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reduced table to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">return_df</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="si">}</span><span class="s2"> entries &quot;</span><span class="p">)</span>
    <span class="c1">#print(f&quot;Time for query = {time.time() - st}&quot;)</span>
    <span class="k">if</span> <span class="n">return_idx</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">return_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">return_df</span></div>

<span class="n">restrict_df_from_list</span> <span class="o">=</span> <span class="n">query_table_from_list</span>

<div class="viewcode-block" id="bbox_query"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.bbox_query">[docs]</a><span class="k">def</span> <span class="nf">bbox_query</span><span class="p">(</span>
    <span class="n">coordinate_name</span><span class="o">=</span><span class="s2">&quot;centroid&quot;</span><span class="p">,</span>
    
    <span class="c1"># -- arguments for creating the bounding box</span>
    <span class="n">center</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bbox</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">buffer_array</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">buffer_percentage</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">buffer_array_multipier</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    
    <span class="c1"># ---- for creating query</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">inside</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">upper_case</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">),</span>
    
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Want to create a query that</span>
<span class="sd">    will restrict coordinates to a rectangular</span>
<span class="sd">    window</span>

<span class="sd">    &quot;&quot;&quot;</span>

    
    <span class="n">bbox</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">bbox_with_buffer</span><span class="p">(</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">center</span><span class="p">,</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">,</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">,</span>
        <span class="n">buffer_array</span><span class="o">=</span><span class="n">buffer_array</span><span class="p">,</span>
        <span class="n">percentage</span> <span class="o">=</span> <span class="n">buffer_percentage</span><span class="p">,</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="n">buffer_array_multipier</span><span class="p">,</span>
        <span class="n">subtract_buffer</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>


    <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="n">upper_case</span><span class="p">:</span>
        <span class="n">joiner</span> <span class="o">=</span> <span class="s2">&quot;AND&quot;</span>
        <span class="n">notter</span> <span class="o">=</span> <span class="s2">&quot;NOT&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">joiner</span> <span class="o">=</span> <span class="s2">&quot;and&quot;</span>
        <span class="n">notter</span> <span class="o">=</span> <span class="s2">&quot;not&quot;</span>


    <span class="n">inequalities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ineq</span><span class="p">,</span><span class="n">array</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;&gt;=&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;=&quot;</span><span class="p">],</span><span class="n">bbox</span><span class="p">):</span>
        <span class="n">inequalities</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">coordinate_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">xyz</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ineq</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;z&quot;</span><span class="p">])]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inequalities = </span><span class="si">{</span><span class="n">inequalities</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">joiner</span><span class="si">}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inequalities</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">inside</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">notter</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">))&quot;</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bbox query = </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> 
        
    <span class="k">return</span> <span class="n">query</span></div>


<div class="viewcode-block" id="radius_query"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.radius_query">[docs]</a><span class="k">def</span> <span class="nf">radius_query</span><span class="p">(</span>
    <span class="n">center</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">,</span>
    <span class="n">coordinate_name</span> <span class="o">=</span> <span class="s2">&quot;centroid&quot;</span><span class="p">,</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;z&quot;</span><span class="p">),</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">inside</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">upper_case</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Query to Find if coordintes are inside a radius</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    Design a query that computes</span>
<span class="sd">    sqrt((x - x_coord)**2 + (y - y_coord)**2 + (z - z_coord)**2) &lt; radius</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">upper_case</span><span class="p">:</span>
        <span class="n">sqrt_func</span> <span class="o">=</span> <span class="s2">&quot;SQRT&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sqrt_func</span> <span class="o">=</span> <span class="s2">&quot;sqrt&quot;</span>
    
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;((</span><span class="si">{</span><span class="n">coordinate_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ax</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s2">) * (</span><span class="si">{</span><span class="n">coordinate_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ax</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s2">))&quot;</span> <span class="k">for</span> <span class="n">ax</span><span class="p">,</span><span class="n">coord</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span><span class="n">center</span><span class="p">)])</span>

    <span class="k">if</span> <span class="n">inside</span><span class="p">:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="s2">&quot;&lt;=&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="s2">&quot;&gt;=&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sqrt_func</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;radius query = </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">query</span></div>

<div class="viewcode-block" id="restrict_df_to_coordinates_within_radius"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.restrict_df_to_coordinates_within_radius">[docs]</a><span class="k">def</span> <span class="nf">restrict_df_to_coordinates_within_radius</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">center</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">,</span>
    <span class="n">within_radius</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;_nm&quot;</span><span class="p">,</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">),</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
    
    <span class="n">curr_query</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">radius_query</span><span class="p">(</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">center</span><span class="p">,</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span><span class="p">,</span>
        <span class="n">inside</span> <span class="o">=</span> <span class="n">within_radius</span><span class="p">,</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix</span><span class="p">,</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">,</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
        <span class="n">coordinate_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">curr_query</span><span class="p">)</span></div>

<div class="viewcode-block" id="distance_between_coordinates"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.distance_between_coordinates">[docs]</a><span class="k">def</span> <span class="nf">distance_between_coordinates</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">coordinate_column_1</span><span class="p">,</span>
    <span class="n">coordinate_column_2</span><span class="p">,</span>
    <span class="n">coordinate_column_1_suffix</span><span class="o">=</span><span class="s2">&quot;nm&quot;</span><span class="p">,</span>
    <span class="n">coordinate_column_2_suffix</span><span class="o">=</span><span class="s2">&quot;nm&quot;</span><span class="p">,</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>
    <span class="p">):</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coordinate_column_1</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ax</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">coordinate_column_1_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coordinate_column_2</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ax</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">coordinate_column_2_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
               <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">),</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="vector_between_coordinates"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.vector_between_coordinates">[docs]</a><span class="k">def</span> <span class="nf">vector_between_coordinates</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">coordinate_column_1</span><span class="p">,</span>
    <span class="n">coordinate_column_2</span><span class="p">,</span>
    <span class="n">coordinate_column_1_suffix</span><span class="o">=</span><span class="s2">&quot;nm&quot;</span><span class="p">,</span>
    <span class="n">coordinate_column_2_suffix</span><span class="o">=</span><span class="s2">&quot;nm&quot;</span><span class="p">,</span>
    <span class="p">):</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coordinate_column_1</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ax</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">coordinate_column_1_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coordinate_column_2</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ax</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">coordinate_column_2_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
               <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;z&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="distance_from_vector"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.distance_from_vector">[docs]</a><span class="k">def</span> <span class="nf">distance_from_vector</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">vector_column</span><span class="p">,</span>
    <span class="n">vector_column_suffix</span><span class="o">=</span><span class="s2">&quot;nm&quot;</span><span class="p">,</span>
    <span class="p">):</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">vector_column</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ax</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">vector_column_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
               <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;z&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">),</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="reduce_mem_usage"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.reduce_mem_usage">[docs]</a><span class="k">def</span> <span class="nf">reduce_mem_usage</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; iterate through all the columns of a dataframe and modify the data type</span>
<span class="sd">        to reduce memory usage.        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_mem</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">2</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Memory usage of dataframe is </span><span class="si">{:.2f}</span><span class="s1"> MB&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_mem</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">col_type</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
        
        <span class="k">if</span> <span class="n">col_type</span> <span class="o">!=</span> <span class="nb">object</span><span class="p">:</span>
            <span class="n">c_min</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">c_max</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_type</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;int&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>  
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>

    <span class="n">end_mem</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">2</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Memory usage after optimization is: </span><span class="si">{:.2f}</span><span class="s1"> MB&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end_mem</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Decreased by </span><span class="si">{:.1f}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">start_mem</span> <span class="o">-</span> <span class="n">end_mem</span><span class="p">)</span> <span class="o">/</span> <span class="n">start_mem</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">df</span></div>

<span class="n">pandas_alternatives_for_large_datasets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">ray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">modin</span> <span class="o">=</span> <span class="s2">&quot;https://modin.readthedocs.io/en/stable/&quot;</span>
<span class="p">)</span>


<div class="viewcode-block" id="source_target_coordinate_edges"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.source_target_coordinate_edges">[docs]</a><span class="k">def</span> <span class="nf">source_target_coordinate_edges</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">source_column</span> <span class="o">=</span> <span class="s2">&quot;presyn_centroid&quot;</span><span class="p">,</span>
    <span class="n">target_column</span> <span class="o">=</span> <span class="s2">&quot;postsyn_centroid&quot;</span><span class="p">,</span>
    <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;nm&#39;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Get edges from source, target</span>
<span class="sd">    coordinate edges </span>
<span class="sd">    &quot;&quot;&quot;</span>
   
    <span class="n">pre_coords</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">coordinates_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">source_column</span><span class="p">,</span><span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">post_coords</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">coordinates_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">target_column</span><span class="p">,</span><span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">pre_post_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">pre_coords</span><span class="p">,</span><span class="n">post_coords</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pre_post_edges</span></div>


<div class="viewcode-block" id="split_df_to_source_target_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.split_df_to_source_target_df">[docs]</a><span class="k">def</span> <span class="nf">split_df_to_source_target_df</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">source_name</span> <span class="o">=</span> <span class="s2">&quot;presyn&quot;</span><span class="p">,</span>
    <span class="n">target_name</span> <span class="o">=</span> <span class="s2">&quot;postsyn&quot;</span><span class="p">,</span>
    <span class="n">append_type</span> <span class="o">=</span> <span class="s2">&quot;prefix&quot;</span><span class="p">,</span>
    <span class="n">source_columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">target_columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">include_source_target_name_in_columns</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">source_target_name_not_in_eachother_columns</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To split a dataframe into source and </span>
<span class="sd">    target dataframe</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Divide the dataframe into the source column, target columns</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">column_to_name</span><span class="p">(</span><span class="n">column</span><span class="p">,</span><span class="n">append_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">append_name</span>
        <span class="k">if</span> <span class="n">append_type</span> <span class="o">==</span> <span class="s2">&quot;prefix&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">append_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="n">append_type</span> <span class="o">==</span> <span class="s2">&quot;suffix&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">append_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="n">append_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">append_name_in_columns</span><span class="p">(</span><span class="n">column</span><span class="p">,</span><span class="n">append_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">append_type</span> <span class="o">==</span> <span class="s2">&quot;prefix&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">append_name</span> <span class="o">==</span> <span class="n">column</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">append_name</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">append_type</span> <span class="o">==</span> <span class="s2">&quot;suffix&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">append_name</span> <span class="o">==</span> <span class="n">column</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">append_name</span><span class="p">):]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">source_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">source_columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">column_to_name</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">source_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">columns</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">source_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">append_name_in_columns</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">source_name</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">source_target_name_not_in_eachother_columns</span><span class="p">:</span>
            <span class="n">source_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">source_columns</span> <span class="k">if</span> <span class="n">target_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">include_source_target_name_in_columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">source_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source_columns</span><span class="p">:</span>
            <span class="n">source_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">source_name</span><span class="p">]</span> <span class="o">+</span> <span class="n">source_columns</span>
            
    <span class="n">source_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">source_columns</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">source_columns (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">source_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">) = </span><span class="si">{</span><span class="n">source_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">target_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">column_to_name</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">target_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">columns</span>
            <span class="p">]</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">append_name_in_columns</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">target_name</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">source_target_name_not_in_eachother_columns</span><span class="p">:</span>
            <span class="n">target_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">target_columns</span> <span class="k">if</span> <span class="n">source_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">include_source_target_name_in_columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">target_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target_columns</span><span class="p">:</span>
            <span class="n">target_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">target_name</span><span class="p">]</span> <span class="o">+</span> <span class="n">target_columns</span>
            
    <span class="n">target_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">target_columns</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">target_columns (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">target_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">) = </span><span class="si">{</span><span class="n">target_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">source_columns</span><span class="p">],</span><span class="n">df</span><span class="p">[</span><span class="n">target_columns</span><span class="p">]</span></div>

<div class="viewcode-block" id="randomly_sample_source_target_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.randomly_sample_source_target_df">[docs]</a><span class="k">def</span> <span class="nf">randomly_sample_source_target_df</span><span class="p">(</span>
    <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    
    <span class="n">n_samples</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">replace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    
    <span class="c1"># -- arguments for the source_target_split</span>
    <span class="n">source_df</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">target_df</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    
    <span class="n">columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">source_name</span> <span class="o">=</span> <span class="s2">&quot;presyn&quot;</span><span class="p">,</span>
    <span class="n">target_name</span> <span class="o">=</span> <span class="s2">&quot;postsyn&quot;</span><span class="p">,</span>
    <span class="n">append_type</span> <span class="o">=</span> <span class="s2">&quot;prefix&quot;</span><span class="p">,</span>
    <span class="n">source_columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">target_columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">include_source_target_name_in_columns</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">source_target_name_not_in_eachother_columns</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To create a random sampling of source</span>
<span class="sd">    and target from a source-target dataframe. This is to </span>
<span class="sd">    create synthetic data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">source_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">target_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">source_df</span><span class="p">,</span><span class="n">target_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">split_df_to_source_target_df</span><span class="p">(</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">,</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span><span class="p">,</span>
            <span class="n">source_name</span> <span class="o">=</span> <span class="n">source_name</span><span class="p">,</span>
            <span class="n">target_name</span> <span class="o">=</span> <span class="n">target_name</span><span class="p">,</span>
            <span class="n">append_type</span> <span class="o">=</span> <span class="n">append_type</span><span class="p">,</span>
            <span class="n">source_columns</span> <span class="o">=</span> <span class="n">source_columns</span><span class="p">,</span>
            <span class="n">target_columns</span> <span class="o">=</span> <span class="n">target_columns</span><span class="p">,</span>
            <span class="n">include_source_target_name_in_columns</span> <span class="o">=</span> <span class="n">include_source_target_name_in_columns</span><span class="p">,</span>
            <span class="n">source_target_name_not_in_eachother_columns</span> <span class="o">=</span> <span class="n">source_target_name_not_in_eachother_columns</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">source_df_samp</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">randomly_sample_df</span><span class="p">(</span>
        <span class="n">source_df</span><span class="p">,</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">n_samples</span><span class="p">,</span>
        <span class="n">replace</span><span class="o">=</span><span class="n">replace</span><span class="p">,</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">target_df_samp</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">randomly_sample_df</span><span class="p">(</span>
        <span class="n">target_df</span><span class="p">,</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">n_samples</span><span class="p">,</span>
        <span class="n">replace</span><span class="o">=</span><span class="n">replace</span><span class="p">,</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">df_samp</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">source_df_samp</span><span class="p">,</span><span class="n">target_df_samp</span><span class="p">],</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_samp</span></div>
    
<div class="viewcode-block" id="replace_str_characters"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.replace_str_characters">[docs]</a><span class="k">def</span> <span class="nf">replace_str_characters</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">replace_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">column</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">to_replace</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">in_place</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: want to replace a string</span>
<span class="sd">    character with another in a column/columns</span>
<span class="sd">    of a dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_place</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">column</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    
    <span class="n">column</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nu</span><span class="o">.</span><span class="n">array_like</span><span class="p">(</span><span class="n">column</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">replace_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">replace_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">column</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">replace_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>

<span class="c1">#from datasci_tools import numpy_utils as nu</span>
<div class="viewcode-block" id="keys_from_groupby_obj"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.keys_from_groupby_obj">[docs]</a><span class="k">def</span> <span class="nf">keys_from_groupby_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: get the groupby object</span>
<span class="sd">    keys</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>

<div class="viewcode-block" id="split_df_by_groupby_column"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.split_df_by_groupby_column">[docs]</a><span class="k">def</span> <span class="nf">split_df_by_groupby_column</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">return_keys</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Want to divide a dataset by a groupby statement</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">column</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nu</span><span class="o">.</span><span class="n">array_like</span><span class="p">(</span><span class="n">column</span><span class="p">))</span>
    <span class="n">gb</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>    
    <span class="n">all_dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">gb</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">gb</span><span class="o">.</span><span class="n">groups</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of groups = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_dfs</span><span class="p">)</span><span class="si">}</span><span class="s2"> (total time = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">return_keys</span><span class="p">:</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">gb</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">all_dfs</span><span class="p">,</span><span class="n">keys</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">all_dfs</span></div>
    
    
<div class="viewcode-block" id="append_to_column_names"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.append_to_column_names">[docs]</a><span class="k">def</span> <span class="nf">append_to_column_names</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">append_str</span><span class="p">,</span>
    <span class="n">append_type</span> <span class="o">=</span> <span class="s2">&quot;prefix&quot;</span><span class="p">,</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">columns_to_omit</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
    <span class="k">if</span> <span class="n">append_type</span> <span class="o">==</span> <span class="s2">&quot;prefix&quot;</span><span class="p">:</span>
        <span class="n">curr_str</span> <span class="o">=</span> <span class="s1">&#39;f&quot;</span><span class="si">{append_str}</span><span class="s1">_</span><span class="si">{k}</span><span class="s1">&quot;&#39;</span>
    <span class="k">elif</span> <span class="n">append_type</span> <span class="o">==</span> <span class="s2">&quot;suffix&quot;</span><span class="p">:</span>
        <span class="n">curr_str</span> <span class="o">=</span> <span class="s1">&#39;f&quot;</span><span class="si">{k}</span><span class="s1">_</span><span class="si">{append_str}</span><span class="s1">&quot;&#39;</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">columns_to_omit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns_to_omit</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">append_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="nb">eval</span><span class="p">(</span><span class="n">curr_str</span><span class="p">,</span><span class="nb">locals</span><span class="p">(),</span><span class="nb">globals</span><span class="p">())</span> 
                  <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">append_str</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,[</span><span class="n">append_str</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span>
                  <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns_to_omit</span> <span class="p">}</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;append_dict= </span><span class="si">{</span><span class="n">append_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">pu</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">append_dict</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="merge_dfs_with_same_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.merge_dfs_with_same_columns">[docs]</a><span class="k">def</span> <span class="nf">merge_dfs_with_same_columns</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">df_append</span><span class="p">,</span>
    <span class="n">on</span><span class="p">,</span>
    <span class="n">how</span> <span class="o">=</span> <span class="s2">&quot;inner&quot;</span><span class="p">,</span>
    <span class="n">append_str</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
    <span class="n">append_type</span><span class="o">=</span><span class="s1">&#39;suffix&#39;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: to merge 2 dataframes</span>
<span class="sd">    with same columns but want to keep them distinct</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">on</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">array_like</span><span class="p">(</span><span class="n">on</span><span class="p">)</span>
    
    <span class="n">df_append</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">append_to_column_names</span><span class="p">(</span>
        <span class="n">df_append</span><span class="p">,</span>
        <span class="n">append_str</span><span class="o">=</span><span class="n">append_str</span><span class="p">,</span>
        <span class="n">append_type</span><span class="o">=</span><span class="n">append_type</span><span class="p">,</span>
        <span class="n">columns_to_omit</span> <span class="o">=</span> <span class="n">on</span> <span class="p">,</span>
        
    <span class="p">)</span>
    
    <span class="n">df_after_merge</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">df_append</span><span class="p">,</span>
        <span class="n">on</span> <span class="o">=</span> <span class="n">on</span><span class="p">,</span>
        <span class="n">how</span> <span class="o">=</span> <span class="n">how</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df_after_merge</span></div>

<div class="viewcode-block" id="dict_column_to_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.dict_column_to_columns">[docs]</a><span class="k">def</span> <span class="nf">dict_column_to_columns</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_new_columns</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: to unpack a column that is a list of dicts</span>
<span class="sd">    into columns themselves</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">df_dicts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New columns = </span><span class="si">{</span><span class="n">df_dicts</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">df_with_dicts</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
        <span class="n">pu</span><span class="o">.</span><span class="n">delete_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">column</span><span class="p">),</span><span class="n">df_dicts</span>
    <span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">return_new_columns</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df_with_dicts</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="n">df_dicts</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df_with_dicts</span></div>
    
<div class="viewcode-block" id="map_column_with_dict_slow"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.map_column_with_dict_slow">[docs]</a><span class="k">def</span> <span class="nf">map_column_with_dict_slow</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">dict_map</span><span class="p">,</span>
    <span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">in_place</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_place</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">new_column_from_dict_mapping</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">dict_map</span><span class="o">=</span><span class="n">dict_map</span><span class="p">,</span>
        <span class="n">column_name</span><span class="o">=</span><span class="n">column</span><span class="p">,</span>
        <span class="n">default_value</span><span class="o">=</span><span class="n">default_value</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total time = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span></div>




<div class="viewcode-block" id="map_column_with_dict"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.map_column_with_dict">[docs]</a><span class="k">def</span> <span class="nf">map_column_with_dict</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">dict_map</span><span class="p">,</span>
    <span class="n">use_default_value</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">default_value</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">in_place</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
    
    
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_place</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
    <span class="n">columns</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">original_labels</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">dict_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2"> == &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;int query&quot;</span><span class="p">)</span>
                <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2"> == </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">set_column_subset_value_by_query</span><span class="p">(</span>
                <span class="n">df</span><span class="p">,</span>
                <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                <span class="n">column</span> <span class="o">=</span> <span class="n">column</span><span class="p">,</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">v</span>

            <span class="p">)</span>

        <span class="k">if</span> <span class="n">use_default_value</span><span class="p">:</span>
            <span class="c1"># # --- setting the default value ---</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">nu</span><span class="o">.</span><span class="n">mask_of_array_1_elements_in_array_2</span><span class="p">(</span>
                <span class="n">original_labels</span><span class="p">,</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">dict_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="p">))</span>  

            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_value</span>
        
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total time = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="set_categorical_order_on_column"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.set_categorical_order_on_column">[docs]</a><span class="k">def</span> <span class="nf">set_categorical_order_on_column</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">order</span><span class="p">,</span>
    <span class="n">order_in_least_to_greatest</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">order_in_least_to_greatest</span><span class="p">:</span>
        <span class="n">order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">order</span><span class="p">))</span>
    
    <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">set_categories</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="sort_df_by_categorical_column"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.sort_df_by_categorical_column">[docs]</a><span class="k">def</span> <span class="nf">sort_df_by_categorical_column</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">order</span><span class="p">,</span>
    <span class="n">order_in_least_to_greatest</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To order a dataframe from </span>
<span class="sd">    a categorical column</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">df_with_order</span> <span class="o">=</span> <span class="n">set_categorical_order_on_column</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">column</span><span class="p">,</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">,</span>
        <span class="n">order_in_least_to_greatest</span><span class="o">=</span><span class="n">order_in_least_to_greatest</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">pu</span><span class="o">.</span><span class="n">sort_df_by_column</span><span class="p">(</span>
        <span class="n">df_with_order</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="n">column</span><span class="p">,</span>
        <span class="n">ascending</span> <span class="o">=</span> <span class="n">ascending</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="df_of_coordinates_and_labels_from_dict"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.df_of_coordinates_and_labels_from_dict">[docs]</a><span class="k">def</span> <span class="nf">df_of_coordinates_and_labels_from_dict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">nu</span><span class="o">.</span><span class="n">df_of_coordinates_and_labels_from_dict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="aggregate_over_column"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.aggregate_over_column">[docs]</a><span class="k">def</span> <span class="nf">aggregate_over_column</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">group_column</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">aggregator</span> <span class="o">=</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
    <span class="n">divisor</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: to aggregate a column over</span>
<span class="sd">    the dataframe</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    pu.aggregate_over_column(</span>
<span class="sd">        edits_df,</span>
<span class="sd">        group_column = &quot;split_type&quot;,</span>
<span class="sd">        column = &quot;error_branches_skeleton_length&quot;,</span>
<span class="sd">        divisor = 1000,</span>
<span class="sd">    )</span>
<span class="sd">    &quot;&quot;&quot;</span>

<span class="c1">#     aggregator = &quot;sum&quot;</span>
<span class="c1">#     column = &quot;error_branches_skeleton_length&quot;</span>
<span class="c1">#     group_column = &quot;split_type&quot;</span>
<span class="c1">#     divisor = 1000</span>
    <span class="n">aggr_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="n">group_column</span><span class="p">,</span><span class="n">column</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">group_column</span><span class="p">]),</span><span class="n">aggregator</span><span class="p">)()</span>
    <span class="k">if</span> <span class="n">divisor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">aggr_df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggr_df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">/</span><span class="n">divisor</span>
    <span class="k">return</span> <span class="n">aggr_df</span></div>


<div class="viewcode-block" id="label_to_coordinate_dict_from_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.label_to_coordinate_dict_from_df">[docs]</a><span class="k">def</span> <span class="nf">label_to_coordinate_dict_from_df</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">label_column</span> <span class="o">=</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span>
    <span class="n">coordinate_prefix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">coordinate_suffix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To convert a dataframe with coordinatea and labels</span>
<span class="sd">    into a dictionary mapping the labels to the coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df_divided</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">divide_dataframe_by_column_value</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">label_column</span>
    <span class="p">)</span>
    <span class="n">coord_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">lab</span><span class="p">,</span><span class="n">pu</span><span class="o">.</span><span class="n">coordinates_from_df</span><span class="p">(</span>
        <span class="n">k</span><span class="p">,</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">coordinate_prefix</span><span class="p">,</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">coordinate_suffix</span><span class="p">))</span>
     <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">lab</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df_divided</span><span class="p">,</span><span class="n">labels</span><span class="p">)])</span>

    <span class="k">return</span> <span class="n">coord_dict</span></div>


<div class="viewcode-block" id="xlim_ylim_from_coordinate_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.xlim_ylim_from_coordinate_df">[docs]</a><span class="k">def</span> <span class="nf">xlim_ylim_from_coordinate_df</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span>
    <span class="p">):</span>
    
    <span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
    <span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">df</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
    
    <span class="k">return</span> <span class="n">xlim</span><span class="p">,</span><span class="n">ylim</span></div>

<div class="viewcode-block" id="order_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.order_columns">[docs]</a><span class="k">def</span> <span class="nf">order_columns</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">columns_at_front</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">columns_at_back</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To order the columns of  </span>
<span class="sd">    a dataframe</span>
<span class="sd">    </span>
<span class="sd">    Pseudocode: </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">columns_at_front</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns_at_front</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">columns_at_back</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns_at_back</span><span class="o">=</span> <span class="p">[]</span>
        
    <span class="n">columns_at_front</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns_at_front</span><span class="p">)</span>
    <span class="n">columns_at_back</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns_at_back</span><span class="p">)</span>
    
    <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">columns_left_over</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span><span class="n">columns_at_front</span><span class="p">)</span>
    <span class="n">columns_left_over</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">columns_left_over</span><span class="p">,</span><span class="n">columns_at_back</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">columns_at_front</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns_left_over</span><span class="p">)</span> <span class="o">+</span> <span class="n">columns_at_back</span><span class="p">]</span></div>
                  
<div class="viewcode-block" id="normalize_to_sum_1"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.normalize_to_sum_1">[docs]</a><span class="k">def</span> <span class="nf">normalize_to_sum_1</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">axis</span><span class="p">)</span></div>

<div class="viewcode-block" id="restrict_df_by_min_max"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.restrict_df_by_min_max">[docs]</a><span class="k">def</span> <span class="nf">restrict_df_by_min_max</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">columns_to_plot</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To restrict a dataframe</span>
<span class="sd">    by min and max of columns and just</span>
<span class="sd">    tell which columns and what min through </span>
<span class="sd">    arguments</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    pu.restrict_df_by_min_max(</span>
<span class="sd">        spine_df_trans_umap,</span>
<span class="sd">        verbose = True,</span>
<span class="sd">        umap_1_max = -2.5,</span>
<span class="sd">        umap_0_max = 5,</span>
<span class="sd">        umap_0_min = 0</span>
<span class="sd">    )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">restrictions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">columns_used</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">k</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;_min&quot;</span><span class="p">:</span>
            <span class="n">restrictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> &gt;= </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;_max&quot;</span><span class="p">:</span>
            <span class="n">restrictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> &lt;= </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns_used</span><span class="p">:</span>
            <span class="n">columns_used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;restrictions = </span><span class="si">{</span><span class="n">restrictions</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">df_restr</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">query_table_from_list</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">restrictions</span><span class="p">,</span>
        <span class="n">verbose_filtering</span><span class="o">=</span><span class="n">verbose</span>
    <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">columns_to_plot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">columns_to_plot</span> <span class="o">=</span> <span class="n">columns_used</span>
        <span class="n">area_coords</span> <span class="o">=</span> <span class="n">df_restr</span><span class="p">[</span><span class="n">columns_to_plot</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">whole_coords</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns_to_plot</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">whole_coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">whole_coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;unrestricted&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">area_coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">area_coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;restricted&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">columns_to_plot</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">columns_to_plot</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">df_restr</span></div>

<div class="viewcode-block" id="closest_row_to_coordinate"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.closest_row_to_coordinate">[docs]</a><span class="k">def</span> <span class="nf">closest_row_to_coordinate</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">coordinate</span><span class="p">,</span>
    <span class="n">coordinate_name</span> <span class="o">=</span> <span class="s2">&quot;mesh_center&quot;</span><span class="p">,</span>
    <span class="n">return_df</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To find the row idx of the </span>
<span class="sd">    rows that have the closest coordinate to </span>
<span class="sd">    a coordinate</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Export the coordinates of dataframe</span>
<span class="sd">    2) Find the closest idx to each coordinate</span>
<span class="sd">    3) return the idx or a dataframe</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    pu.closest_row_to_coordinate(</span>
<span class="sd">        df = spine_df,</span>
<span class="sd">        coordinate_name = &quot;mesh_center&quot;,</span>
<span class="sd">        coordinate = np.array([829181.89697582, 494363.38581494, 899399.53232649]),</span>
<span class="sd">        return_df = True,</span>
<span class="sd">    )</span>
<span class="sd">    &quot;&quot;&quot;</span>



    
    <span class="k">if</span> <span class="n">coordinate</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">single_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">single_flag</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">coords</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">coordinates_from_df</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">coordinate_name</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">closest_idx_for_each_coordinate</span><span class="p">(</span><span class="n">coordinate</span><span class="p">,</span><span class="n">array_for_idx</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closest rows = </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_df</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">,:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">single_flag</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">idx</span></div>
    
<div class="viewcode-block" id="randomly_sample_classes_from_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.randomly_sample_classes_from_df">[docs]</a><span class="k">def</span> <span class="nf">randomly_sample_classes_from_df</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">n_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To randomly sample from each</span>
<span class="sd">    class from a column and concatenate the results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n_samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">samples_dict</span> <span class="o">=</span> <span class="n">n_samples</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">samples_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">shuffle_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="n">all_dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
        <span class="n">curr_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2"> == &#39;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">samples_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span><span class="n">n_samples</span><span class="p">),:]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2">: # of samples = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">all_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_df</span><span class="p">)</span>

    <span class="n">all_dfs</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_dfs</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_dfs</span></div>

<div class="viewcode-block" id="min_max_from_column"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.min_max_from_column">[docs]</a><span class="k">def</span> <span class="nf">min_max_from_column</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_dict</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">buffer_perc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">column</span><span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nu</span><span class="o">.</span><span class="n">is_array_like</span><span class="p">(</span><span class="n">column</span><span class="p">):</span>
        <span class="n">column</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span><span class="p">]</span>
        <span class="n">single_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">single_flag</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="n">min_maxes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">column</span><span class="p">:</span>
        <span class="n">min_v</span><span class="p">,</span><span class="n">max_v</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">buffer_perc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">buffer_perc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">buffer_v</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_v</span> <span class="o">-</span> <span class="n">min_v</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">buffer_perc</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">min_v</span> <span class="o">=</span> <span class="n">min_v</span> <span class="o">-</span> <span class="n">buffer_v</span>
            <span class="n">max_v</span> <span class="o">=</span> <span class="n">max_v</span> <span class="o">+</span> <span class="n">buffer_v</span>
        <span class="n">min_maxes</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_v</span><span class="p">,</span><span class="n">max_v</span><span class="p">)</span>
        
    <span class="n">min_maxes_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">min_maxes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    
    <span class="k">if</span> <span class="n">single_flag</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">min_maxes_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">min_maxes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">min_maxes_values</span></div>
        
        
<div class="viewcode-block" id="weighted_average_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.weighted_average_df">[docs]</a><span class="k">def</span> <span class="nf">weighted_average_df</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">group_by_columns</span><span class="p">,</span>
    <span class="n">weight_column</span><span class="p">,</span>
    <span class="n">columns_to_delete</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">flatten</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Compose a weighted average</span>
<span class="sd">    dataframe from a column in a dataframe </span>
<span class="sd">    serving as the weights and </span>
<span class="sd">    all the rest of the columns being averaged</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    curr_df = df.query(f&quot;compartment == &#39;basal&#39;&quot;).reset_index(drop=True)</span>
<span class="sd">    print(len(curr_df))</span>
<span class="sd">    curr_df_w = pu.weighted_average_df(</span>
<span class="sd">        curr_df,</span>
<span class="sd">        weight_column = &quot;width&quot;,</span>
<span class="sd">        columns_to_delete = [&quot;node&quot;,],</span>
<span class="sd">        group_by_columns = [&quot;segment_id&quot;,&quot;split_index&quot;,&quot;compartment&quot;],</span>
<span class="sd">        verbose = True,</span>
<span class="sd">    )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
    <span class="n">df_to_group</span> <span class="o">=</span> <span class="n">df</span>
    <span class="n">df_to_group</span> <span class="o">=</span> <span class="n">df_to_group</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">weight_column</span><span class="si">}</span><span class="s2"> &gt; 0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">columns_to_delete</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df_to_group</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">delete_columns</span><span class="p">(</span><span class="n">df_to_group</span><span class="p">,</span><span class="n">columns_to_delete</span><span class="p">)</span>

    <span class="n">wm</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">weights</span> <span class="o">=</span> <span class="n">df_to_group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">weight_column</span><span class="p">])</span>
    <span class="n">df_weight</span> <span class="o">=</span> <span class="n">df_to_group</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_by_columns</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">wm</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total time for weighted average = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">flatten</span><span class="p">:</span>
        <span class="n">df_weight</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">flatten_row_multi_index</span><span class="p">(</span><span class="n">df_weight</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_weight</span></div>
    
<div class="viewcode-block" id="normalize_vector_magnitude"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.normalize_vector_magnitude">[docs]</a><span class="k">def</span> <span class="nf">normalize_vector_magnitude</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;synapse&quot;</span><span class="p">,</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;nm&quot;</span><span class="p">,</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;z&quot;</span><span class="p">),</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">in_place</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Want to vector noramlize</span>
<span class="sd">    a group of columns in a dataframe</span>

<span class="sd">    Psuedocode: </span>
<span class="sd">    1) Construct the column names that will be extracted</span>
<span class="sd">    2) extract the coordinates</span>
<span class="sd">    3) Compute the norm</span>
<span class="sd">    4) Divide column by the norm</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_place</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">columns</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">coordinate_columns</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix</span><span class="p">,</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">coordinates</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">coordinates_from_df</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">magn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">/</span><span class="n">magn</span>
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="reorder_levels"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.reorder_levels">[docs]</a><span class="k">def</span> <span class="nf">reorder_levels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">order</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Will reorder the columns or row indexes</span>
<span class="sd">    if multi level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">reorder_levels</span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">)</span></div>

<div class="viewcode-block" id="unstack"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.unstack">[docs]</a><span class="k">def</span> <span class="nf">unstack</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Can cnvert a index to a column index</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">)</span></div>

<div class="viewcode-block" id="convert_series_to_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.convert_series_to_df">[docs]</a><span class="k">def</span> <span class="nf">convert_series_to_df</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span></div>

<div class="viewcode-block" id="unravel_df_into_single_row_with_col_prefixes"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.unravel_df_into_single_row_with_col_prefixes">[docs]</a><span class="k">def</span> <span class="nf">unravel_df_into_single_row_with_col_prefixes</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">columns</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: If did a groupby and have columns that represent</span>
<span class="sd">    unique combinations then can make dataframe one row dataframe</span>
<span class="sd">    and put those column combinations as prefixes to columns</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">new_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reorder_levels</span><span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="n">new_order</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">v</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">v</span></div>




<div class="viewcode-block" id="group_df_for_count_and_average"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.group_df_for_count_and_average">[docs]</a><span class="k">def</span> <span class="nf">group_df_for_count_and_average</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">columns</span><span class="p">,</span>
    <span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">return_one_row_df</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To group columns by averaging and counting</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">df_lite</span> <span class="o">=</span> <span class="n">df</span>
    
    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df_lite</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>
    <span class="n">df_lite</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">replace_nan_with_default</span><span class="p">(</span><span class="n">df_lite</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="n">default_value</span><span class="p">)</span>
    <span class="n">df_lite</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">replace_None_with_default</span><span class="p">(</span><span class="n">df_lite</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="n">default_value</span><span class="p">)</span>
    <span class="n">df_lite</span><span class="p">[</span><span class="n">features</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lite</span><span class="p">[</span><span class="n">features</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>

<span class="c1">#     reduced_df = pu.flatten_row_multi_index(df_lite.groupby(</span>
<span class="c1">#         columns</span>
<span class="c1">#     ).mean())</span>

    <span class="n">reduced_df</span> <span class="o">=</span> <span class="n">df_lite</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
        <span class="n">columns</span>
    <span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  

    <span class="n">cont_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">count_unique_column_values</span><span class="p">(</span><span class="n">df_lite</span><span class="p">,</span><span class="n">columns</span><span class="p">)</span>

    <span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">reduced_df</span><span class="p">,</span>
        <span class="n">cont_df</span><span class="p">,</span>
        <span class="n">how</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="n">on</span> <span class="o">=</span> <span class="n">columns</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">return_one_row_df</span><span class="p">:</span>
        <span class="n">stats_df</span> <span class="o">=</span> <span class="n">unravel_df_into_single_row_with_col_prefixes</span><span class="p">(</span>
            <span class="n">stats_df</span><span class="p">,</span>
            <span class="n">columns</span>
        <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">stats_df</span></div>

<div class="viewcode-block" id="divide_df_by_column_bins"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.divide_df_by_column_bins">[docs]</a><span class="k">def</span> <span class="nf">divide_df_by_column_bins</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#equal_width,#equal_depth</span>
    <span class="n">n_bins</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="c1">#arguments for filtering</span>
    <span class="n">percentile_buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">percentile_lower</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">percentile_upper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>

    <span class="n">overlap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">return_bins</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">flatten_return_bins</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Want to split up a dataframe</span>
<span class="sd">    with bins or number of bins perscribed</span>
<span class="sd">    over a column value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">intervals</span> <span class="o">=</span> <span class="n">bins</span>
    <span class="n">n_intervals</span> <span class="o">=</span> <span class="n">n_bins</span>
    <span class="n">interval_attribute</span> <span class="o">=</span> <span class="n">column</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">intervals</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">bin_array</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">interval_attribute</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
            <span class="n">n_bins</span> <span class="o">=</span> <span class="n">n_intervals</span><span class="p">,</span>
            <span class="n">bin_type</span> <span class="o">=</span> <span class="n">intervals</span>
        <span class="p">)</span>
        <span class="n">intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">intervals</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">intervals</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">elif</span> <span class="n">intervals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">intervals</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">intervals</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">intervals</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">interval_attribute</span><span class="si">}</span><span class="s2"> == </span><span class="si">{</span><span class="n">interval_attribute</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">filter_df_by_column_percentile</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="n">interval_attribute</span><span class="p">,</span>
        <span class="n">percentile_buffer</span><span class="o">=</span><span class="n">percentile_buffer</span><span class="p">,</span>
        <span class="n">percentile_lower</span> <span class="o">=</span> <span class="n">percentile_lower</span><span class="p">,</span>
        <span class="n">percentile_upper</span> <span class="o">=</span> <span class="n">percentile_upper</span><span class="p">,</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1">#2) Get the continuous value you will bin and divide it up intervals</span>
    <span class="n">interval_vals</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">interval_attribute</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">intervals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">intervals</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">interval_bins_covering_array</span><span class="p">(</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">interval_vals</span><span class="p">,</span>
            <span class="n">n_intervals</span> <span class="o">=</span> <span class="n">n_intervals</span><span class="p">,</span>
            <span class="n">overlap</span> <span class="o">=</span> <span class="n">overlap</span><span class="p">,</span> <span class="c1">#if this is a percentage then it is a proportion of the interval</span>
            <span class="n">outlier_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">all_dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,(</span><span class="n">lower</span><span class="p">,</span><span class="n">upper</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">intervals</span><span class="p">):</span>
        <span class="n">df_curr</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">interval_attribute</span><span class="si">}</span><span class="s2"> &gt;= </span><span class="si">{</span><span class="n">lower</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;and (</span><span class="si">{</span><span class="n">interval_attribute</span><span class="si">}</span><span class="s2"> &lt;= </span><span class="si">{</span><span class="n">upper</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

        <span class="n">all_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_curr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">lower</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">upper</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_curr</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples &quot;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">return_bins</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">flatten_return_bins</span><span class="p">:</span>
            <span class="n">intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">intervals</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],[</span><span class="n">intervals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]]])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">all_dfs</span><span class="p">,</span><span class="n">intervals</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">all_dfs</span></div>

    
<span class="c1">#import seaborn as sns</span>
<div class="viewcode-block" id="histogram_2d"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.histogram_2d">[docs]</a><span class="k">def</span> <span class="nf">histogram_2d</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">x</span><span class="p">,</span>
    <span class="n">y</span><span class="p">,</span>
    <span class="n">n_x_bins</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">n_y_bins</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">x_bins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">y_bins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_bins</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">normalize_rows</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_df</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: compute a 2D</span>
<span class="sd">    histogram array of 2 columns</span>
<span class="sd">    in a dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x_bins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x_bins</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">equal_width_bins</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
            <span class="n">n_x_bins</span>
        <span class="p">)</span>

    <span class="n">ret_dfs</span><span class="p">,</span><span class="n">y_bins</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">divide_df_by_column_bins</span><span class="p">(</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">,</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">y_bins</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="o">=</span><span class="n">n_y_bins</span><span class="p">,</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
        <span class="n">return_bins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">flatten_return_bins</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>

    <span class="n">hists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">curr_df</span> <span class="ow">in</span> <span class="n">ret_dfs</span><span class="p">:</span>
        <span class="n">hist_values</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
            <span class="n">curr_df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">x_bins</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">hists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hist_values</span><span class="p">)</span>

    <span class="n">hists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">hists</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">normalize_rows</span><span class="p">:</span>
        <span class="n">hists</span> <span class="o">=</span> <span class="p">(</span><span class="n">hists</span><span class="o">/</span><span class="p">(</span><span class="n">hists</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
        
    <span class="n">stat_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">hists</span><span class="p">)</span>
    <span class="n">stat_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x_bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">x_bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">stat_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">y_bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">y_bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">stat_df</span><span class="p">,</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;Blues&quot;</span>
        <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">return_df</span><span class="p">:</span>
        <span class="n">hists</span> <span class="o">=</span> <span class="n">stat_df</span>
    <span class="k">if</span> <span class="n">return_bins</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hists</span><span class="p">,</span><span class="n">x_bins</span><span class="p">,</span><span class="n">y_bins</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hists</span></div>
    
    
<div class="viewcode-block" id="new_column_from_str_func"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.new_column_from_str_func">[docs]</a><span class="k">def</span> <span class="nf">new_column_from_str_func</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">funcs</span><span class="p">):</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">funcs</span><span class="p">)</span><span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">funcs</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">funcs</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">funcs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">funcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">funcs</span><span class="p">]</span>
        
    <span class="n">curr_df</span> <span class="o">=</span> <span class="n">df</span>
    <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
        <span class="n">curr_df</span> <span class="o">=</span> <span class="n">curr_df</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">curr_df</span></div>

<div class="viewcode-block" id="new_column_from_name_to_str_func_dict"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.new_column_from_name_to_str_func_dict">[docs]</a><span class="k">def</span> <span class="nf">new_column_from_name_to_str_func_dict</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">func_dict</span><span class="p">):</span>
    
    <span class="k">return</span> <span class="n">new_column_from_str_func</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">func_dict</span><span class="p">)</span></div>

<span class="c1">#from datasci_tools import matplotlib_utils as mu</span>
<span class="c1">#from datasci_tools import numpy_utils as nu</span>
<span class="c1">#from datasci_tools import ipyvolume_utils as ipvu</span>
<div class="viewcode-block" id="plot_class_coordinates"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.plot_class_coordinates">[docs]</a><span class="k">def</span> <span class="nf">plot_class_coordinates</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">centroid_column</span> <span class="o">=</span> <span class="s2">&quot;centroid&quot;</span><span class="p">,</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;nm&quot;</span><span class="p">,</span>
    <span class="n">classes_colors</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: to plot the excitatory and inhibitory cells</span>
<span class="sd">    in a dataframe that has their coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">classes_colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">classes_colors</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">generate_non_randon_named_color_list</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">classes_colors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">classes_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">classes_colors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">classes_colors</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">classes_colors</span><span class="p">)</span>

    <span class="n">scatters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scatters_colors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">cl</span><span class="p">,</span><span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span><span class="n">classes_colors</span><span class="p">):</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">coordinates_from_df</span><span class="p">(</span>
                <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2"> == &#39;</span><span class="si">{</span><span class="n">cl</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">),</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">centroid_column</span><span class="p">,</span>
                <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of coords for </span><span class="si">{</span><span class="n">cl</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">) = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">scatters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">coords</span>
        <span class="p">)</span>

        <span class="n">scatters_colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    
    
    <span class="n">ipvu</span><span class="o">.</span><span class="n">plot_multi_scatters</span><span class="p">(</span>
        <span class="n">scatters</span><span class="o">=</span><span class="n">scatters</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">scatters_colors</span><span class="p">,</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
        

    <span class="p">)</span></div>
    
<div class="viewcode-block" id="bin_idx_for_column"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.bin_idx_for_column">[docs]</a><span class="k">def</span> <span class="nf">bin_idx_for_column</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">n_bins</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">add_bin_idx</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">bin_idx_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">add_bin_midpoint</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">bin_midpoint_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">in_place</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_df</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">bin_idx_name_default</span> <span class="o">=</span> <span class="s2">&quot;bin_idx&quot;</span><span class="p">,</span>
    <span class="n">bin_midpoint_name_default</span> <span class="o">=</span> <span class="s2">&quot;bin_midpoint&quot;</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: to assign a bin value for a column</span>
<span class="sd">    in a dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">return_df</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">add_bin_idx</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">add_bin_midpoint</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Doing nothing&quot;</span><span class="p">)</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_place</span> <span class="ow">and</span> <span class="p">(</span><span class="n">add_bin_idx</span> <span class="ow">or</span> <span class="n">add_bin_midpoint</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">column_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">bin_array</span><span class="p">(</span>
        <span class="n">column_data</span><span class="p">,</span>
        <span class="n">n_bins</span> <span class="o">=</span> <span class="n">n_bins</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">bin_assignment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span>
        <span class="n">column_data</span><span class="p">,</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="n">bins</span>
    <span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">bin_assignment</span><span class="p">[</span><span class="n">bin_assignment</span> <span class="o">&gt;=</span> <span class="n">n_bins</span> <span class="p">]</span> <span class="o">=</span> <span class="n">n_bins</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">bin_mids</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>

    <span class="k">if</span> <span class="n">add_bin_idx</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bin_idx_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bin_idx_name</span><span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bin_idx_name_default</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">df</span><span class="p">[</span><span class="n">bin_idx_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin_assignment</span>

    <span class="k">if</span> <span class="n">add_bin_midpoint</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bin_midpoint_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bin_midpoint_name</span><span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bin_midpoint_name_default</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">df</span><span class="p">[</span><span class="n">bin_midpoint_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin_mids</span><span class="p">[</span><span class="n">bin_assignment</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">display</span><span class="p">(</span><span class="n">pu</span><span class="o">.</span><span class="n">count_unique_column_values</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">bin_idx_name</span><span class="p">))</span>
    <span class="c1"># if plot:</span>
    <span class="c1">#     dummy_name = f&quot;{bin_midpoint_name} &quot;</span>
    <span class="c1">#     df[dummy_name] = [</span>
    <span class="c1">#         str(np.round(k,2)) for k in df[bin_midpoint_name].to_list()]</span>
    <span class="c1">#     df[&quot;count&quot;] = 1</span>
    <span class="c1">#     sns.barplot(</span>
    <span class="c1">#         data=df,</span>
    <span class="c1">#         y = dummy_name,</span>
    <span class="c1">#         x = column,</span>
    <span class="c1">#         color = &quot;blue&quot;</span>
    <span class="c1">#     )</span>

    <span class="c1">#     df = pu.delete_columns(df,dummy_name)</span>

    <span class="k">if</span> <span class="n">return_df</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">bin_assignment</span><span class="p">,</span><span class="n">bin_mids</span></div>
<div class="viewcode-block" id="col_to_datatype_dict"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.col_to_datatype_dict">[docs]</a><span class="k">def</span> <span class="nf">col_to_datatype_dict</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">to_list</span><span class="p">()]</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span><span class="n">dt</span> <span class="k">for</span> <span class="n">col</span><span class="p">,</span><span class="n">dt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span><span class="n">dtypes</span><span class="p">)}</span></div>

<div class="viewcode-block" id="columns_of_datatype"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.columns_of_datatype">[docs]</a><span class="k">def</span> <span class="nf">columns_of_datatype</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">datatype</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,):</span>
    <span class="n">col_dt_dict</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">col_to_datatype_dict</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span><span class="p">,</span><span class="n">dt</span> <span class="ow">in</span> <span class="n">col_dt_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">datatype</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Columns of </span><span class="si">{</span><span class="n">datatype</span><span class="si">}</span><span class="s2"> datatype: </span><span class="se">\n</span><span class="si">{</span><span class="n">cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cols</span></div>

<div class="viewcode-block" id="float_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.float_columns">[docs]</a><span class="k">def</span> <span class="nf">float_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,):</span>
    <span class="k">return</span> <span class="n">columns_of_datatype</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">datatype</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="round_float_cols"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.round_float_cols">[docs]</a><span class="k">def</span> <span class="nf">round_float_cols</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">column_precision_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">cols_to_ignore</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To round all float columns</span>
<span class="sd">    to a specified precision</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">cols_to_ignore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cols_to_ignore</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">column_precision_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">column_precision_dict</span><span class="o">=</span> <span class="p">{}</span>

    <span class="n">float_cols</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">float_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">float_cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">column_precision_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cols_to_ignore</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">column_precision_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">precision</span>
            
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">column_precision_dict</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="flip_rows"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.flip_rows">[docs]</a><span class="k">def</span> <span class="nf">flip_rows</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="mode_aggr_groupby"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.mode_aggr_groupby">[docs]</a><span class="k">def</span> <span class="nf">mode_aggr_groupby</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">groupby_columns</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="p">):</span>
    
    <span class="n">groupby_columns</span><span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nu</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">groupby_columns</span><span class="p">))</span>
    <span class="c1">#columns= list(nu.to_list(columns))</span>
    
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupby_columns</span><span class="p">)[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="filter_df_splits_by_column_percentile"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.filter_df_splits_by_column_percentile">[docs]</a><span class="k">def</span> <span class="nf">filter_df_splits_by_column_percentile</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">split_columns</span><span class="p">,</span>
    <span class="n">percentile_upper</span><span class="o">=</span><span class="mf">99.5</span><span class="p">,</span>
    <span class="n">percentile_lower</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To filter multiple dataframe splits</span>
<span class="sd">    to a certain percentage and then stack into dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Before filtering </span><span class="si">{</span><span class="n">split_columns</span><span class="si">}</span><span class="s2"> column to </span><span class="si">{</span><span class="p">[</span><span class="n">percentile_lower</span><span class="p">,</span><span class="n">percentile_upper</span><span class="p">]</span><span class="si">}</span><span class="s2"> perc = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span><span class="n">pu</span><span class="o">.</span><span class="n">filter_df_by_column_percentile</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">columns</span> <span class="o">=</span> <span class="n">column</span><span class="p">,</span><span class="n">percentile_lower</span><span class="o">=</span><span class="n">percentile_lower</span><span class="p">,</span><span class="n">percentile_upper</span><span class="o">=</span><span class="n">percentile_upper</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pu</span><span class="o">.</span><span class="n">split_df_by_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">columns</span> <span class="o">=</span> <span class="n">split_columns</span><span class="p">)],</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AFTER filtering </span><span class="si">{</span><span class="n">split_columns</span><span class="si">}</span><span class="s2"> column to </span><span class="si">{</span><span class="p">[</span><span class="n">percentile_lower</span><span class="p">,</span><span class="n">percentile_upper</span><span class="p">]</span><span class="si">}</span><span class="s2"> perc = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="cumulative_count_within_groupby"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.cumulative_count_within_groupby">[docs]</a><span class="k">def</span> <span class="nf">cumulative_count_within_groupby</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">group_columns</span><span class="p">,</span>
    <span class="n">base_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To cumutatively count</span>
<span class="sd">    the rows in a groupby</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_columns</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="n">base_idx</span></div>

<div class="viewcode-block" id="flatten_pivot_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.flatten_pivot_df">[docs]</a><span class="k">def</span> <span class="nf">flatten_pivot_df</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">index_name</span> <span class="o">=</span> <span class="s2">&quot;index&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To flatten the results of a pivot table</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Rename the </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">curr_df</span> <span class="o">=</span> <span class="n">df</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">curr_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">flatten_column_multi_index</span><span class="p">(</span><span class="n">curr_df</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">curr_df</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cols</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">}</span>
    <span class="n">rename_dict</span>

    <span class="n">curr_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">flatten_row_multi_index</span><span class="p">(</span><span class="n">curr_df</span><span class="p">)</span>
    <span class="n">curr_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">delete_columns</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pu</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">(</span><span class="n">curr_df</span><span class="p">,</span><span class="n">rename_dict</span><span class="p">)),</span>
        <span class="n">columns_to_delete</span><span class="o">=</span><span class="p">[</span><span class="n">cols</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">curr_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">index_name</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">curr_df</span></div>

<div class="viewcode-block" id="top_k_extrema_attributes_as_columns_by_group"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.top_k_extrema_attributes_as_columns_by_group">[docs]</a><span class="k">def</span> <span class="nf">top_k_extrema_attributes_as_columns_by_group</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">group_columns</span><span class="p">,</span>
    <span class="n">extrema</span> <span class="o">=</span> <span class="s2">&quot;largest&quot;</span><span class="p">,</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;_idx&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To create colums that are the k</span>
<span class="sd">    extrema of a certain attribute within a group</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Filter df to k extrema of column inside group</span>
<span class="sd">    2) Label the idx of each row inside the group</span>
<span class="sd">    3) Create a pivot table to make those rows as columns</span>
<span class="sd">    4) Flatten pivot table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sort_column</span> <span class="o">=</span> <span class="n">column</span>

    <span class="c1"># Purpose: Want to collapse to the top k widths of a certain compartment</span>
    <span class="n">df_sort_top_k</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">filter_to_extrema_k_of_group</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">group_columns</span><span class="o">=</span><span class="n">group_columns</span><span class="p">,</span>
        <span class="n">sort_columns</span><span class="o">=</span><span class="n">sort_column</span><span class="p">,</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">,</span>
        <span class="n">extrema</span><span class="o">=</span><span class="n">extrema</span><span class="p">,</span>

    <span class="p">)</span>

    <span class="n">df_sort_top_k</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sort_column</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">cumulative_count_within_groupby</span><span class="p">(</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df_sort_top_k</span><span class="p">,</span>
        <span class="n">group_columns</span> <span class="o">=</span> <span class="n">group_columns</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">df_sort_pivot</span> <span class="o">=</span> <span class="n">df_sort_top_k</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">group_columns</span><span class="p">,</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sort_column</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="n">sort_column</span>
    <span class="p">)</span>
    <span class="n">df_sort_pivot</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">flatten_pivot_df</span><span class="p">(</span>
        <span class="n">df_sort_pivot</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df_sort_pivot</span></div>

<div class="viewcode-block" id="bin_for_column"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.bin_for_column">[docs]</a><span class="k">def</span> <span class="nf">bin_for_column</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">n_bins</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">as_str</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">generate_color_palette</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">bin_name</span> <span class="o">=</span> <span class="s2">&quot;bin&quot;</span><span class="p">,</span>
    <span class="n">divisor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="c1">#as_str_precision = 2</span>
    <span class="p">):</span>
    
    <span class="n">df_to_plot</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">bin_idx_for_column</span><span class="p">(</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">,</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">column</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">bin_to_plot</span> <span class="o">=</span> <span class="n">bin_name</span>
    
    <span class="n">df_to_plot</span><span class="p">[</span><span class="n">bin_to_plot</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="n">divisor</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df_to_plot</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">_bin_midpoint&quot;</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="n">df_to_plot</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">sort_df_by_column</span><span class="p">(</span>
        <span class="n">df_to_plot</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="n">bin_to_plot</span><span class="p">,</span>
        <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">as_str</span><span class="p">:</span>
        <span class="n">df_to_plot</span><span class="p">[</span><span class="n">bin_to_plot</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df_to_plot</span><span class="p">[</span><span class="n">bin_to_plot</span><span class="p">]]</span>
    
    <span class="k">if</span> <span class="n">generate_color_palette</span><span class="p">:</span>
        <span class="n">unique_bins</span> <span class="o">=</span> <span class="n">df_to_plot</span><span class="p">[</span><span class="n">bin_to_plot</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">color_palette</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">unique_bins</span><span class="p">,</span><span class="n">mu</span><span class="o">.</span><span class="n">generate_non_randon_named_color_list</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_bins</span><span class="p">))</span>
        <span class="p">)}</span>
        
        <span class="k">return</span> <span class="n">df_to_plot</span><span class="p">,</span><span class="n">color_palette</span>
    <span class="k">return</span> <span class="n">df_to_plot</span></div>
    
<div class="viewcode-block" id="apply_func_to_grouped_df"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.apply_func_to_grouped_df">[docs]</a><span class="k">def</span> <span class="nf">apply_func_to_grouped_df</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">group_columns</span><span class="p">,</span>
    <span class="n">func</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: to apply a function to the dataframes</span>
<span class="sd">    that are the result of grouping a dataframe</span>
<span class="sd">    (and returns the resultant dataframe)</span>
<span class="sd">    </span>
<span class="sd">    Requirements: </span>
<span class="sd">    func must return a dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">return_df</span> <span class="o">=</span>  <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_columns</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">return_df</span><span class="o">=</span><span class="n">flatten_column_multi_index</span><span class="p">(</span><span class="n">return_df</span><span class="p">,</span><span class="n">join_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time for apply_func = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">return_df</span></div>

<div class="viewcode-block" id="bin_array_column"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.bin_array_column">[docs]</a><span class="k">def</span> <span class="nf">bin_array_column</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span> <span class="o">=</span> <span class="s2">&quot;centroid&quot;</span><span class="p">,</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;nm&quot;</span><span class="p">,</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">],</span>
    <span class="n">bin_suffix</span> <span class="o">=</span> <span class="s2">&quot;bin&quot;</span><span class="p">,</span>
    <span class="n">bin_mid_suffix</span> <span class="o">=</span> <span class="s2">&quot;bin_mid&quot;</span><span class="p">,</span>
    <span class="n">bin_width</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_bins</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">add_bin_mid</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">add_bin_idx</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">in_place</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: bin coordinates of dataframe</span>
<span class="sd">    into n dimensions and add the bins</span>
<span class="sd">    and the midpoints of the bins to dataframe</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Extract the coordinates</span>
<span class="sd">    2) bin the coordinates</span>
<span class="sd">    3) assign the bin idx and bin midpoints</span>
<span class="sd">    to the dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_place</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">bin_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bin_suffix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ax</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>
    <span class="n">bin_mid_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bin_mid_suffix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ax</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>
    <span class="n">a_idx</span><span class="p">,</span><span class="n">a_mid</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">bin_ndim_array</span><span class="p">(</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">coordinates_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">column</span><span class="p">,</span><span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix</span><span class="p">,</span><span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">),</span>
        <span class="n">bin_width</span><span class="o">=</span><span class="n">bin_width</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span>
        <span class="n">return_bin_centers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">add_bin_idx</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">bin_names</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_idx</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">add_bin_idx</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">bin_mid_names</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_mid</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
    

    <span class="k">return</span> <span class="n">df</span></div>

<span class="c1">#from datasci_tools import matplotlib_utils as mu</span>
<div class="viewcode-block" id="plot_gradients_over_coordiante_columns"><a class="viewcode-back" href="../../datasci_tools.html#datasci_tools.pandas_utils.plot_gradients_over_coordiante_columns">[docs]</a><span class="k">def</span> <span class="nf">plot_gradients_over_coordiante_columns</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mu</span><span class="o">.</span><span class="n">plot_gradients_over_coordiante_columns</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
                  

<span class="c1">#from datasci_tools import pandas_utils as pu</span>




<span class="c1">#--- from datasci_tools ---</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">general_utils</span> <span class="k">as</span> <span class="n">gu</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ipyvolume_utils</span> <span class="k">as</span> <span class="n">ipvu</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">matplotlib_utils</span> <span class="k">as</span> <span class="n">mu</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">numpy_utils</span> <span class="k">as</span> <span class="n">nu</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">regex_utils</span> <span class="k">as</span> <span class="n">reu</span>
<span class="kn">from</span> <span class="nn">.tqdm_utils</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">pandas_utils</span> <span class="k">as</span> <span class="n">pu</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Brendan Celii.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>